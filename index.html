<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Case Builder (5-Jahre)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx.js) f√ºr Excel-Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Basis-Stile */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        
        /* NEU: Input-Felder f√ºr Formatierung (Typ text) */
        input.formatted {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            width: 100%;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Layout-Stile f√ºr P&L und KPI Tabellen (WICHTIG F√úR DAS LAYOUT) */
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        
        .data-grid {
            display: grid;
        }
        
        /* Definition der Spaltenbreiten (ANGEPASST F√úR 5 JAHRE) */
        .grid-cols-pnl {
            /* 1 fixe Spalte + 6 Jahre (T0-T5) * 2 Spalten (Euro + %) = 13 Spalten */
            grid-template-columns: minmax(240px, 1fr) repeat(12, minmax(110px, 1fr));
            min-width: 1600px;
        }
        .grid-cols-kpi {
            /* 1 fixe Spalte + 6 Jahre (T0-T5) * 1 Spalte (Wert) = 7 Spalten */
            grid-template-columns: minmax(240px, 1fr) repeat(6, minmax(110px, 1fr));
            min-width: 900px;
        }
        
        .grid-cols-kpi-input-projects {
            /* 1 fixe Spalte (Projekt) + 1 fixe Spalte (Wirkung) + 5 Jahre (T1-T5) = 7 Spalten */
            grid-template-columns: minmax(220px, 1fr) minmax(220px, 1fr) repeat(5, minmax(90px, 1fr));
            min-width: 900px;
        }

        /* Zellen-Stile */
        .grid-cell {
            padding: 6px 10px;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.875rem; /* 14px */
        }
        .grid-cell:last-child { border-right: none; }
        
        /* Header-Zellen */
        .grid-header {
            background-color: #f9fafb; /* Leichtes Grau */
            font-weight: 700;
            color: #374151; /* Dunkelgrau */
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        /* Fixierte (Sticky) Spalten-Zellen (Links) */
        .grid-sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #ffffff; /* Wei√üer Hintergrund, um √úberlappung zu verdecken */
            border-right: 2px solid #d1d5db; /* St√§rkere Trennlinie */
            font-weight: 500;
        }
        .grid-header.grid-sticky-col {
            z-index: 30; /* Muss √ºber dem Header UND der Spalte sein */
            background-color: #f3f4f6;
        }
        
        .pnl-subtotal { background-color: #eff6ff; font-weight: 700; } /* Blau f√ºr DBs */
        .pnl-final { background-color: #e0e7ff; font-weight: 800; } /* Dunkleres Blau f√ºr Ergebnis */
        .pnl-header-row { background-color: #e5e7eb; grid-column: 1 / -1; font-weight: 700; } /* Grau f√ºr Sektions-Header */
        .pnl-percent { color: #6b7280; font-size: 0.75rem; } /* %-Werte */
        .kpi-row { background-color: #fdfdff; }
        
        /* KPI Input Matrix Stile */
        .kpi-input-grid { display: grid; }
        .kpi-input-grid .grid-cell { padding: 2px; }
        .kpi-input-grid input {
            padding: 4px; border: none; width: 100%; text-align: right; background-color: transparent;
            font-size: 0.875rem;
        }
        .kpi-input-grid input:focus { outline: 1px solid #3b82f6; }
        .kpi-input-grid .grid-sticky-col { background-color: #fefce8; } /* Gelber Hintergrund f√ºr KPI-Label */
        .kpi-input-grid .grid-header { background-color: #fef3c7; } /* Dunkleres Gelb f√ºr KPI-Header */

        /* Tab-Stile */
        .tab-button {
            padding: 0.5rem 1rem; /* Kompaktere Tabs */
            border-bottom-width: 2px;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            white-space: nowrap;
        }
        .tab-button.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
        .tab-button.inactive {
            border-color: transparent;
            color: #6b7280; /* gray-500 */
        }
        .tab-button.inactive:hover {
            border-color: #d1d5db; /* gray-300 */
            color: #374151; /* gray-700 */
        }
        /* Style f√ºr Lade-Dropdowns */
        .load-dropdown {
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }
        .load-dropdown select {
            flex-grow: 1;
            border-radius: 0.375rem;
            border-color: #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* NEU: Delete-Button */
        .delete-button {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            font-weight: 700;
            border-radius: 50%;
            width: 38px; /* Feste Breite */
            height: 38px; /* Feste H√∂he */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: 1px solid #fecaca; /* red-300 */
        }
        .delete-button:hover {
            background-color: #fecaca; /* red-200 */
        }

        /* Styling f√ºr Logistik-Inputs */
        .logistics-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .input-group {
             display: flex;
             flex-direction: column;
        }
        .input-group label {
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            color: #374151; /* gray-700 */
            margin-bottom: 0.25rem;
        }
        /* Verwendung der .formatted-Klasse f√ºr Inputs */
        .input-group input.formatted {
             /* Stile sind bereits oben definiert */
        }

        /* Styling f√ºr Datei-Upload-Felder */
        .file-upload-input {
            display: block;
            width: 100%;
            font-size: 0.875rem;
            color: #4b5563;
            file:mr-4 file:py-2 file:px-4
            file:rounded-full file:border-0
            file:text-sm file:font-semibold
            file:bg-indigo-100 file:text-indigo-700
            hover:file:bg-indigo-200;
        }
        
        /* Styling f√ºr Toggle-Switch */
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 34px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: #4f46e5;
        }
        input:checked + .slider:before {
          transform: translateX(26px);
        }
        
        /* NEU: Logistik-Rechner Ergebnis-Box */
        .logi-result-box {
            background-color: #f0f9ff; /* sky-50 */
            border: 1px solid #bae6fd; /* sky-200 */
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .logi-result-box h4 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #0c4a6e; /* sky-800 */
            border-bottom: 2px solid #bae6fd;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .logi-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .logi-result-item {
            background-color: #ffffff;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #e0f2fe;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .logi-result-item dt {
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            truncate: true;
        }
        .logi-result-item dd {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0c4a6e;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-full mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">
        <header class="mb-8 flex flex-col md:flex-row justify-between md:items-start">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 border-b-4 border-indigo-200 pb-2">
                    Business Case Builder (5-Jahre)
                </h1>
                <p class="text-gray-500 mt-2">Modelliert P&L-Effekte von Projekten √ºber einen flexiblen 5-Jahres-Horizont.</p>
            </div>
            
            <!-- User Info und Status -->
            <div class="text-left md:text-right text-sm mt-4 md:mt-0">
                <p class="font-semibold text-gray-700">Status: <span id="authStatus" class="text-red-600">Initialisiere...</span></p>
                <p class="text-xs text-gray-500 truncate">User ID: <span id="currentUserId">Warte auf Anmeldung...</span></p>
                
                <!-- Speichern/Laden Sektion -->
                <div class="mt-4 flex flex-col md:items-end space-y-2">
                    <!-- Business Case Speichern -->
                    <div class="flex items-center space-x-2 w-full">
                        <input type="text" id="scenarioNameInput" placeholder="Business Case Name" class="w-full md:w-auto rounded-lg border-gray-300 shadow-sm p-2 border-2">
                        <button id="saveScenarioBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                            Speichern
                        </button>
                    </div>
                </div>

            </div>
        </header>

        <!-- NEU: Tab-Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-pnl" onclick="showTab('pnl')" class="tab-button active">P&L & KPIs</button>
                <button id="tab-projects" onclick="showTab('projects')" class="tab-button inactive">Projekt-Steuerung</button>
                <button id="tab-logistics" onclick="showTab('logistics')" class="tab-button inactive">Logistik-Parameter</button>
            </nav>
        </div>

        <!-- NEU: Tab-Container -->
        <div>
            <!-- Tab 1: P&L & KPIs (Standardansicht) -->
            <div id="pane-pnl">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
                    <!-- Linke Spalte: Eingaben & Steuerung -->
                    <div class="lg:col-span-1 space-y-8">
                        
                        <!-- NEU: Laden/L√∂schen (Hierher verschoben) -->
                        <div class="p-4 bg-gray-50 rounded-lg shadow-inner space-y-4">
                            <h2 class="text-xl font-bold text-gray-700">Laden & L√∂schen</h2>
                             <!-- Business Case Laden -->
                            <div class="p-2 border rounded-lg bg-white">
                                <label for="caseSelector" class="block text-sm font-medium text-gray-700 mb-1">Business Case (Gesamtes Tool)</label>
                                <div class="load-dropdown">
                                     <select id="caseSelector" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                                        <option value="">--- Business Case laden ---</option>
                                    </select>
                                    <button id="deleteCaseBtn" class="delete-button" title="Ausgew√§hlten Business Case l√∂schen">X</button>
                                    <div id="caseSpinner" class="hidden spinner"></div>
                                </div>
                            </div>
                            
                            <!-- KORREKTUR: Logistik-Laden entfernt -->
                            <div id="scenarioStatus" class="text-xs text-gray-500 text-right w-full"></div>
                        </div>

                        <!-- NEU: Stream Filter -->
                        <div class="p-4 bg-green-50 rounded-lg shadow-inner space-y-4">
                            <h2 class="text-xl font-bold text-green-700">Filterung (P&L / KPIs)</h2>
                            <div class="input-group">
                                <label for="streamFilterSelector" class="font-medium">Nach Business Stream filtern</label>
                                <select id="streamFilterSelector" onchange="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                                    <option value="Alle">Alle Streams</option>
                                    <!-- JS f√ºllt diesen Bereich dynamisch -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- 1. P&L STARTWERTE & ZEITACHSE -->
                        <div class="p-4 bg-indigo-50 rounded-lg shadow-inner space-y-4">
                            <h2 class="text-xl font-bold text-indigo-700">1. Basis & Zeitachse (T=0)</h2>
                            
                            <!-- Basis-Werte Upload -->
                            <div class="p-3 bg-white rounded-lg border border-indigo-200">
                                <label for="baseInputsExcelFile" class="block text-sm font-medium text-gray-700 mb-1">Basis-Werte (T=0) per Excel laden</label>
                                <input type="file" id="baseInputsExcelFile" accept=".xlsx, .xls" class="file-upload-input">
                                <div id="baseInputsImportStatus" class="text-xs text-gray-600 mt-2">Format: Spalte "Parameter" (ID) & "Wert"</div>
                            </div>

                            <div class="input-group">
                                <label for="startYear">Start-Jahr (T=0)</label>
                                <input type="number" id="startYear" value="2024" min="2000" max="2100" step="1" oninput="calculateCase()" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="pnl_kpi_vat_rate">Mehrwertsteuersatz (MwSt. %)</label>
                                <input type="text" id="pnl_kpi_vat_rate" value="19.0" data-raw-value="19.0" onfocus="unformatInput(this)" onblur="formatInput(this, '%')" class="formatted">
                            </div>
                            
                            <h3 class="text-md font-semibold text-indigo-700 mt-4">Basis-Werte (Manuell T=0)</h3>
                            
                            <!-- KORREKTUR: Detaillierte P&L-Inputs (Scrolling entfernt) -->
                            <div class="space-y-4 pr-2">
                                <div class="input-group">
                                    <label for="pnl_1_order_value">Bestellwert (Brutto ‚Ç¨)</label>
                                    <input type="text" id="pnl_1_order_value" value="1.500.000 ‚Ç¨" data-raw-value="1500000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_kpi_return_rate">Retourenquote (%)</label>
                                    <input type="text" id="pnl_kpi_return_rate" value="25,0 %" data-raw-value="25.0" onfocus="unformatInput(this)" onblur="formatInput(this, '%')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_kpi_cogs_rate">Wareneinsatzquote (%)</label>
                                    <input type="text" id="pnl_kpi_cogs_rate" value="40,0 %" data-raw-value="40.0" onfocus="unformatInput(this)" onblur="formatInput(this, '%')" class="formatted">
                                </div>
                                 <div class="input-group">
                                    <label for="pnl_4_other_rev">Sonstige Erl√∂se (Netto ‚Ç¨)</label>
                                    <input type="text" id="pnl_4_other_rev" value="10.000 ‚Ç¨" data-raw-value="10000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                
                                <h4 class="text-sm font-semibold text-indigo-600 pt-2 border-t border-indigo-200">Logistik (Manuell)</h4>
                                
                                <!-- NEU: Logistik-Toggle -->
                                <div class="flex items-center justify-between">
                                    <label for="logisticsToggle" class="text-sm font-medium text-gray-700">Logistik-Kosten (T=0) berechnen?</label>
                                    <label class="switch">
                                        <input type="checkbox" id="logisticsToggle" checked onchange="toggleManualLogistics()">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div id="manualLogisticsInputs" class="hidden space-y-4 pl-4 border-l-2 border-gray-300">
                                    <div class="input-group">
                                        <label for="pnl_6_log_cost">Logistikkosten (OPC, P&P, etc.) (‚Ç¨)</label>
                                        <input type="text" id="pnl_6_log_cost" value="50.000 ‚Ç¨" data-raw-value="50000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                    </div>
                                    <div class="input-group">
                                        <label for="pnl_7_shipping_out">Ausgangsfracht (‚Ç¨)</label>
                                        <input type="text" id="pnl_7_shipping_out" value="30.000 ‚Ç¨" data-raw-value="30000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                    </div>
                                    <div class="input-group">
                                        <label for="pnl_8_shipping_return">Retourenfracht (‚Ç¨)</label>
                                        <input type="text" id="pnl_8_shipping_return" value="20.000 ‚Ç¨" data-raw-value="20000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                    </div>
                                </div>

                                <h4 class="text-sm font-semibold text-indigo-600 pt-2 border-t border-indigo-200">Direkte Kosten</h4>
                                <div class="input-group">
                                    <label for="pnl_9_sales_cost">Vertriebskosten (‚Ç¨)</label>
                                    <input type="text" id="pnl_9_sales_cost" value="50.000 ‚Ç¨" data-raw-value="50000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_10_personnel_direct">Personalkosten (Dir. ‚Ç¨)</label>
                                    <input type="text" id="pnl_10_personnel_direct" value="40.000 ‚Ç¨" data-raw-value="40000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_11_material_cost">Sachkosten (‚Ç¨)</label>
                                    <input type="text" id="pnl_11_material_cost" value="10.000 ‚Ç¨" data-raw-value="10000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_12_depreciation_direct">Abschreibungen (Dir. ‚Ç¨)</label>
                                    <input type="text" id="pnl_12_depreciation_direct" value="10.000 ‚Ç¨" data-raw-value="10000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_13_recharge_direct">Verrechnung (Dir. ‚Ç¨)</label>
                                    <input type="text" id="pnl_13_recharge_direct" value="20.000 ‚Ç¨" data-raw-value="20000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>

                                <h4 class="text-sm font-semibold text-indigo-600 pt-2 border-t border-indigo-200">Gemeinkosten</h4>
                                <div class="input-group">
                                    <label for="pnl_14_marketing">Zentrale Vermarktung (‚Ç¨)</label>
                                    <input type="text" id="pnl_14_marketing" value="80.000 ‚Ç¨" data-raw-value="80000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_15_personnel_overhead">Personalkosten (Overhead ‚Ç¨)</label>
                                    <input type="text" id="pnl_15_personnel_overhead" value="60.000 ‚Ç¨" data-raw-value="60000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_16_depreciation_overhead">Abschreibungen (Overhead ‚Ç¨)</label>
                                    <input type="text" id="pnl_16_depreciation_overhead" value="20.000 ‚Ç¨" data-raw-value="20000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_17_recharge_overhead">Verrechnung (Overhead ‚Ç¨)</label>
                                    <input type="text" id="pnl_17_recharge_overhead" value="10.000 ‚Ç¨" data-raw-value="10000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_18_production">Produktion (‚Ç¨)</label>
                                    <input type="text" id="pnl_18_production" value="10.000 ‚Ç¨" data-raw-value="10000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                                <div class="input-group">
                                    <label for="pnl_19_it_admin">IT/Admin (‚Ç¨)</label>
                                    <input type="text" id="pnl_19_it_admin" value="20.000 ‚Ç¨" data-raw-value="20000" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨')" class="formatted">
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Rechte Spalte: Detaillierte P&L Eingabe und Ergebnisse -->
                    <div class="lg:col-span-3 space-y-6">

                        <!-- 3. P&L Ergebnis √ºber 5 Jahre -->
                        <h2 class="text-2xl font-semibold text-gray-700 mt-8 border-b pb-2">3. P&L Ergebnis (T=0 bis T+5)</h2>
                        <div class="table-container">
                            <!-- KORREKTUR: Header und Body werden jetzt von JS direkt hier eingef√ºgt -->
                            <div id="pnlTable" class="data-grid grid-cols-pnl">
                                <!-- JS f√ºllt diesen Container -->
                            </div>
                        </div>

                        <!-- 4. KPI √úbersichtstabelle -->
                        <h2 class="text-2xl font-semibold text-gray-700 mt-12 border-b pb-2">4. KPI-Entwicklung (T=0 bis T+5)</h2>
                        <div class="table-container mb-8">
                            <!-- KORREKTUR: Header und Body werden jetzt von JS direkt hier eingef√ºgt -->
                            <div id="kpiTable" class="data-grid grid-cols-kpi">
                                <!-- JS f√ºllt diesen Container -->
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-500 mt-4">Hinweis: Die Logistikkosten basieren in T+1 bis T+5 auf den Werten aus Tab 3 und den ge√§nderten KPIs.</p>
                    </div>

                </div>
            </div>

            <!-- Tab 2: Projekt-Steuerung (Standard verborgen) -->
            <div id="pane-projects" class="hidden">
                <div class="max-w-6xl mx-auto space-y-8">
                    <!-- 0. PROJEKTLISTE IMPORTIEREN (Hierher verschoben) -->
                    <div class="p-6 bg-gray-100 rounded-lg shadow-inner border border-gray-300 space-y-4">
                        <h2 class="text-xl font-bold text-indigo-700">0. Projektliste importieren</h2>
                        <label for="excelFileProjects" class="block text-sm font-medium text-gray-700">W√§hlen Sie Ihre Projektliste (.xlsx):</label>
                        <input type="file" id="excelFileProjects" accept=".xlsx, .xls" class="file-upload-input">
                        
                        <div id="projectImportStatus" class="text-sm text-gray-600 mt-2">
                            Warte auf Datei-Upload (0 Projekte geladen).
                        </div>
                    </div>

                    <!-- 2. IMPORTIERTE PROJEKTE & WIRKLOGIK (Hierher verschoben) -->
                    <div class="p-6 bg-yellow-50 rounded-lg shadow-inner border border-yellow-300">
                        <h2 class="text-2xl font-bold text-yellow-700 mb-4">2. Importierte Projekte & Wirklogik</h2>
                        <p class="text-sm text-gray-600 mb-4">
                            Projekte werden aus der Excel-Datei geladen. Tragen Sie hier die j√§hrlichen Effekte f√ºr jedes Projekt ein.
                            Die Gesamt-P&L aggregiert die Summe aller Projekteffekte.
                        </p>
                        
                        <!-- Container f√ºr die dynamisch generierten Projekt-Input-Matrizen -->
                        <div id="projectEffectsContainer" class="space-y-6">
                            <p class="text-gray-500">Bitte laden Sie eine Excel-Projektliste, um die Eingabefelder zu sehen.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEU: Tab 3: Logistik-Parameter (Standard verborgen) -->
            <div id="pane-logistics" class="hidden">
                <div class="max-w-6xl mx-auto space-y-8">
                    <div class="p-6 bg-blue-50 rounded-lg shadow-inner border border-blue-300 space-y-4">
                        <h2 class="text-2xl font-bold text-blue-700 mb-4">Logistik-Parameter (T=0 Basis)</h2>
                        <p class="text-sm text-gray-600 mb-6">
                            Dies sind die T=0 Basis-Parameter f√ºr die Logistikkosten-Berechnung (wenn in Tab 1 aktiviert).
                        </p>
                        
                        <!-- 11 Logistik-Input-Felder -->
                        <div class="logistics-input-grid">
                            <div class="input-group">
                                <label for="log_aspBrutto">Durchschnitts-VK (Brutto ‚Ç¨)</label>
                                <input type="text" id="log_aspBrutto" value="65,00 ‚Ç¨" data-raw-value="65.0" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="log_ipo">Artikel / Bestellung (IPO)</label>
                                <input type="text" id="log_ipo" value="1,2" data-raw-value="1.2" onfocus="unformatInput(this)" onblur="formatInput(this, 'float', 1)" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="log_ipr">Artikel / Retourensendung (IPR)</label>
                                <input type="text" id="log_ipr" value="1,1" data-raw-value="1.1" onfocus="unformatInput(this)" onblur="formatInput(this, 'float', 1)" class="formatted">
                            </div>

                            <div class="input-group">
                                <label for="log_goodsReceiptCostPerItem">Warenannahme (pro Artikel ‚Ç¨)</label>
                                <input type="text" id="log_goodsReceiptCostPerItem" value="0,50 ‚Ç¨" data-raw-value="0.50" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="log_orderProcessingCostPerOrder">Auftragsverarbeitung (pro Bestellung ‚Ç¨)</label>
                                <input type="text" id="log_orderProcessingCostPerOrder" value="1,50 ‚Ç¨" data-raw-value="1.50" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="log_pickPackCostPerItem">Pick & Pack (pro Artikel ‚Ç¨)</label>
                                <input type="text" id="log_pickPackCostPerItem" value="1,10 ‚Ç¨" data-raw-value="1.10" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="log_returnProcessingCostPerItem">Retouren-Aufbereitung (pro Artikel ‚Ç¨)</label>
                                <input type="text" id="log_returnProcessingCostPerItem" value="2,50 ‚Ç¨" data-raw-value="2.50" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                            
                            <div class="input-group">
                                <label for="log_storageCostPerItemPerMonth">Lagerung (pro Artikel / Monat ‚Ç¨)</label>
                                <input type="text" id="log_storageCostPerItemPerMonth" value="0,10 ‚Ç¨" data-raw-value="0.10" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="log_avgStorageDurationMonths">Durchschn. Lagerdauer (Monate)</label>
                                <input type="text" id="log_avgStorageDurationMonths" value="3,0" data-raw-value="3.0" onfocus="unformatInput(this)" onblur="formatInput(this, 'float', 1)" class="formatted">
                            </div>

                            <div class="input-group">
                                <label for="log_shippingCostOut">Versandkosten (Outbound ‚Ç¨)</label>
                                <input type="text" id="log_shippingCostOut" value="4,99 ‚Ç¨" data-raw-value="4.99" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                            <div class="input-group">
                                <label for="log_shippingCostReturnShipment">Versandkosten (Retoure ‚Ç¨)</label>
                                <input type="text" id="log_shippingCostReturnShipment" value="5,99 ‚Ç¨" data-raw-value="5.99" onfocus="unformatInput(this)" onblur="formatInput(this, '‚Ç¨', 2)" class="formatted">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEU: Logistik-Kalkulator Ergebnis-Box -->
                    <div class="logi-result-box mt-8">
                        <h4>Logistik-Kalkulator (T=0 Vorschau)</h4>
                        <div class="logi-result-grid">
                            <div class="logi-result-item">
                                <dt>Bestellvolumen (Anzahl)</dt>
                                <dd id="log_calc_bestellungen">0</dd>
                            </div>
                            <div class="logi-result-item">
                                <dt>Nettoumsatz (Berechnet)</dt>
                                <dd id="log_calc_netto_umsatz">0 ‚Ç¨</dd>
                            </div>
                            <div class="logi-result-item">
                                <dt>Gesamte Logistikkosten</dt>
                                <dd id="log_calc_gesamtkosten">0 ‚Ç¨</dd>
                            </div>
                            <div class="logi-result-item">
                                <dt>Logistikkosten (% v. Netto-Umsatz)</dt>
                                <dd id="log_calc_kosten_pro_netto_umsatz">0,0 %</dd>
                            </div>
                            <div class="logi-result-item">
                                <dt>Logistikkosten (pro Bestellung)</dt>
                                <dd id="log_calc_kosten_pro_bestellung">0,00 ‚Ç¨</dd>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Importiere Firebase Module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, browserSessionPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // KORREKTUR: Imports f√ºr Query (Speichern) hinzugef√ºgt
        import { getFirestore, onSnapshot, collection, query, doc, getDoc, setDoc, setLogLevel, addDoc, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globale Variablen
        let db;
        let auth;
        let userId = 'N/A';
        let isAuthReady = false;
        
        // GETRENNTE KOLLEKTIONEN
        // KORREKTUR: Nur noch Business Cases
        const BUSINESS_CASES_COLLECTION = 'business_cases'; // F√ºr dieses Tool (LESEN/SCHREIBEN)

        let importedProjects = []; 
        let projectInputValues = {}; // Speichert Projekt-Input-Anpassungen
        const PLANNING_HORIZON = 5; // T+1 bis T+5 (REDUZIERT)

        // Hilfsfunktionen zur Formatierung
        const formatterEuro = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const formatterEuro2Dec = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formatterPercent = new Intl.NumberFormat('de-DE', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 });
        const formatterNumber = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const formatterFloat1 = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 1, maximumFractionDigits: 1 });


        // =================================================================
        // HILFSFUNKTIONEN
        // =================================================================
        
        /**
         * Liest den 'data-raw-value' oder den .value
         */
        const getInputValue = (id) => {
            const element = document.getElementById(id);
            if (!element) return 0;
            if (element.dataset.rawValue !== undefined) {
                return parseFloat(element.dataset.rawValue) || 0;
            }
            // Fallback f√ºr 'number' inputs (wie startYear)
            return parseFloat(element.value) || 0;
        };
        
        /**
         * Setzt den 'data-raw-value' UND den formatierten .value
         */
        const setInputValue = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                const numValue = parseFloat(value) || 0;
                
                // Setze den Rohwert, der f√ºr Berechnungen genutzt wird
                if (element.dataset.rawValue !== undefined) {
                    element.dataset.rawValue = numValue;
                }
                
                // Setze den formatierten Wert, den der Nutzer sieht
                if (id.includes('rate') || id.includes('cogs')) {
                    element.value = formatterPercent.format(numValue / 100);
                } else if (id.includes('ipo') || id.includes('ipr') || id.includes('avgStorage')) {
                    element.value = formatterFloat1.format(numValue);
                } else if (id.includes('shipping') || id.includes('CostPer') || id.includes('log_asp')) {
                     element.value = formatterEuro2Dec.format(numValue);
                } else if (id === 'startYear') {
                     element.value = numValue; // Keine Formatierung f√ºr Jahr
                } else {
                    element.value = formatterEuro.format(numValue); // Standard Euro-Formatierung
                }
            }
        };

        /**
         * NEU: Formatiert Inputs beim Verlassen (onblur)
         */
        function formatInput(element, type, decimals = 0) {
            // Ersetze deutsche Kommas durch Punkte f√ºr JS
            let rawValue = parseFloat(element.value.replace(/[^0-9,-]+/g, '').replace(',', '.')) || 0;
            
            // Bei Prozent, teile durch 100, wenn der Nutzer eine gro√üe Zahl eingibt (z.B. 25 statt 0.25)
            if (type === '%' && rawValue > 1) { 
                // Ignoriere diesen Teil, da wir den Rohwert speichern (25 = 25%)
            }
            
            element.dataset.rawValue = rawValue;
            
            // KORREKTUR: Aktualisiere das globale Objekt, falls es ein Projekt-Input ist
            if (element.id.startsWith('project_')) {
                projectInputValues[element.id] = rawValue;
            }

            if (type === '‚Ç¨') {
                if (decimals === 2) {
                    element.value = formatterEuro2Dec.format(rawValue);
                } else {
                    element.value = formatterEuro.format(rawValue);
                }
            } else if (type === '%') {
                element.value = formatterPercent.format(rawValue / 100);
            } else if (type === 'float') {
                element.value = formatterFloat1.format(rawValue);
            }
            calculateCase();
        }

        /**
         * NEU: Entfernt Formatierung beim Betreten (onfocus)
         */
        function unformatInput(element) {
            // Zeige den reinen Rohwert (z.B. 25.0 statt 25,0 %)
            element.value = element.dataset.rawValue || 0;
            element.select();
        }


        /**
         * NEU: Tab-Wechsel-Logik
         */
        function showTab(tabName) {
            document.getElementById('pane-pnl').classList.toggle('hidden', tabName !== 'pnl');
            document.getElementById('pane-projects').classList.toggle('hidden', tabName !== 'projects');
            document.getElementById('pane-logistics').classList.toggle('hidden', tabName !== 'logistics');
            
            document.getElementById('tab-pnl').classList.toggle('active', tabName === 'pnl');
            document.getElementById('tab-pnl').classList.toggle('inactive', tabName !== 'pnl');
            
            document.getElementById('tab-projects').classList.toggle('active', tabName === 'projects');
            document.getElementById('tab-projects').classList.toggle('inactive', tabName !== 'projects');
            
            document.getElementById('tab-logistics').classList.toggle('active', tabName === 'logistics');
            document.getElementById('tab-logistics').classList.toggle('inactive', tabName !== 'logistics');
        }
        
        /**
         * NEU: Logistik-Toggle-Logik
         */
        function toggleManualLogistics() {
            const isChecked = document.getElementById('logisticsToggle').checked;
            // Wenn 'checked' (berechnet), blende manuelle Inputs aus
            document.getElementById('manualLogisticsInputs').classList.toggle('hidden', isChecked);
            calculateCase();
        }


        // =================================================================
        // FIREBASE INITIALISIERUNG & AUTH
        // =================================================================
        async function initFirebase() {
            try {
                // üõë IHRE G√úLTIGE FIREBASE KONFIGURATION üõë
                const firebaseConfig = {
                    apiKey: "AIzaSyDGzrNBazLFhxTI-O-xkdSUU-c4EIWHGF0",
                    authDomain: "business-case-kalkulator.firebaseapp.com",
                    projectId: "business-case-kalkulator",
                    storageBucket: "business-case-kalkulator.firebasestorage.app",
                    messagingSenderId: "439851647109",
                    appId: "1:439851647109:web:50faf47e5970ada8b4a9ec"
                };

                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                document.getElementById('authStatus').textContent = 'Authentifiziere...';

                await setPersistence(auth, browserSessionPersistence).catch(e => console.warn("Persistence konnte nicht gesetzt werden:", e));
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('currentUserId').textContent = userId.substring(0, 10) + '...';
                        document.getElementById('authStatus').textContent = 'Verbunden';
                        document.getElementById('authStatus').classList.remove('text-red-600');
                        document.getElementById('authStatus').classList.add('text-green-600');
                        
                        isAuthReady = true; 
                        // KORREKTUR: loadScenariosListener(); entfernt
                        loadBusinessCasesListener(); // Starte Business Case-Laden
                        calculateCase();
                    } else {
                        document.getElementById('authStatus').textContent = 'Anmeldung fehlgeschlagen';
                        document.getElementById('authStatus').classList.add('text-red-600');
                        isAuthReady = false; 
                        calculateCase();
                    }
                });

            } catch (error) {
                console.error("Kritischer Firebase-Fehler bei Initialisierung/Auth: ", error);
                document.getElementById('authStatus').textContent = 'Fehler!';
                document.getElementById('authStatus').classList.add('text-red-600');
                document.getElementById('currentUserId').textContent = `Firebase: ${error.code || 'UNKNOWN'}`; 
                isAuthReady = false; 
                calculateCase(); 
            }
        }
        
        // =================================================================
        // P&L & KPI STRUKTUR UND DEFINITIONEN
        // =================================================================
        const PNL_STRUCTURE = [
            { id: 'pnl_1_order_value', label: 'Bestellwert (Brutto)', type: 'nominal' },
            { id: 'pnl_2_mwst', label: './. MwSt.', type: 'calculated', isCost: true, isMwst: true },
            { id: 'pnl_3_revenue_fakturiert', label: '= Umsatz fakturiert (Netto)', type: 'calculated', isBold: true },
            // NEU: Retourenquote in P&L
            { id: 'pnl_kpi_return_rate', label: 'Retourenquote (KPI %)', type: 'kpi' }, 
            { id: 'pnl_4_other_rev', label: '+ Sonstige Erl√∂se', type: 'nominal' },
            { id: 'pnl_5_cogs', label: './. Wareneinsatz', type: 'calculated', isCost: true },
            { id: 'DB1', label: '= DB 1', type: 'subtotal', color: 'text-green-600' },
            { id: 'HEADER_LOG', label: 'Abzgl. Logistik & Fracht', type: 'header' },
            { id: 'pnl_6_log_cost', label: './. Logistikkosten (OPC, P&P, etc.)', type: 'calculated', isCost: true },
            { id: 'pnl_7_shipping_out', label: './. Ausgangsfracht', type: 'calculated', isCost: true },
            { id: 'pnl_8_shipping_return', label: './. Retourenfracht', type: 'calculated', isCost: true },
            { id: 'DB2', label: '= DB 2', type: 'subtotal', color: 'text-green-700' },
            { id: 'HEADER_DIRECT', label: 'Abzgl. Direkte Kosten', type: 'header' },
            { id: 'pnl_9_sales_cost', label: './. Vertriebskosten', type: 'nominal', isCost: true },
            { id: 'pnl_10_personnel_direct', label: './. Personalkosten (Dir.)', type: 'nominal', isCost: true },
            { id: 'pnl_11_material_cost', label: './. Sachkosten', type: 'nominal', isCost: true },
            { id: 'pnl_12_depreciation_direct', label: './. Abschreibungen (Dir.)', type: 'nominal', isCost: true },
            { id: 'pnl_13_recharge_direct', label: './. Verrechnung (Dir.)', type: 'nominal', isCost: true },
            { id: 'DB3', label: '= DB 3', type: 'subtotal', color: 'text-green-800' },
            { id: 'HEADER_OVERHEAD', label: 'Abzgl. Gemeinkosten', type: 'header' },
            { id: 'pnl_14_marketing', label: './. Zentrale Vermarktung', type: 'nominal', isCost: true },
            { id: 'pnl_15_personnel_overhead', label: './. Personalkosten (Overhead)', type: 'nominal', isCost: true },
            { id: 'pnl_16_depreciation_overhead', label: './. Abschreibungen (Overhead)', type: 'nominal', isCost: true },
            { id: 'pnl_17_recharge_overhead', label: './. Verrechnung (Overhead)', type: 'nominal', isCost: true },
            { id: 'pnl_18_production', label: './. Produktion', type: 'nominal', isCost: true },
            { id: 'pnl_19_it_admin', label: './. IT/Admin', type: 'nominal', isCost: true },
            { id: 'RESULT', label: '= Gesamtergebnis (EBIT)', type: 'final', color: 'text-purple-700' }
        ];

        const KPI_STRUCTURE = [
            { id: 'orderValueBrutto', label: 'Bestellwert Brutto (‚Ç¨)' },
            { id: 'avgVKBrutto', label: 'Durchschnitts-VK Brutto (‚Ç¨)' },
            { id: 'itemsPerOrder', label: 'Artikel / Bestellung (IPO)' },
            { id: 'ordersVolume', label: 'Zahl der Bestellungen (Anzahl)' },
            { id: 'returnRate', label: 'Retourenquote (%)' },
            { id: 'marketingKUR', label: 'Marketing-KUR (%)' },
            { id: 'personnelRate', label: 'Personalkostenquote (%)' },
            { id: 'wareneinsatzRate', label: 'Wareneinsatzquote (%)' }
        ];

        const KPI_INPUT_EFFECTS = [
            { id: 'orderValueBoost', label: 'Bestellwert-Boost (c.p. %)', valueT1: 0.0 }, // Standard 0, wird pro Projekt gesetzt
            { id: 'returnRateReduction', label: 'Retourenquote Senkung (p.p.)', valueT1: 0.0 }, // p.p. = Prozentpunkte
            { id: 'avgVKBoost', label: 'Durchschnitts-VK Boost (c.p. %)', valueT1: 0.0 },
            { id: 'ipoBoost', label: 'Artikel/Bestellung Boost (c.p. %)', valueT1: 0.0 },
            { id: 'freightCostReduction', label: 'Frachtkosten-Senkung (Nominal %)', valueT1: 0.0 },
            { id: 'personnelCostReduction', label: 'Personal-Kosten-Senkung (%)', valueT1: 0.0 },
            { id: 'marketingCostReduction', label: 'Marketingkosten-Senkung (%)', valueT1: 0.0 },
            { id: 'rechargeCostReduction', label: 'Verrechnungskosten-Senkung (%)', valueT1: 0.0 }
        ];
        
        // NEU: IDs der Logistik-Inputs
        const LOGISTICS_INPUT_IDS = [
            'log_aspBrutto', 'log_ipo', 'log_ipr', 'log_goodsReceiptCostPerItem', 
            'log_orderProcessingCostPerOrder', 'log_pickPackCostPerItem', 
            'log_returnProcessingCostPerItem', 'log_storageCostPerItemPerMonth', 
            'log_avgStorageDurationMonths', 'log_shippingCostOut', 'log_shippingCostReturnShipment'
        ];
        
        // KORREKTUR: IDs der Basis-T=0-Inputs (jetzt detailliert)
        const BASE_INPUT_IDS = [
            'startYear', 'pnl_kpi_vat_rate',
            'pnl_1_order_value', 'pnl_kpi_return_rate', 'pnl_kpi_cogs_rate', 'pnl_4_other_rev',
            // NEU: Manuelle Logistik-Inputs
            'pnl_6_log_cost', 'pnl_7_shipping_out', 'pnl_8_shipping_return',
            'pnl_9_sales_cost', 'pnl_10_personnel_direct', 'pnl_11_material_cost', 'pnl_12_depreciation_direct', 'pnl_13_recharge_direct',
            'pnl_14_marketing', 'pnl_15_personnel_overhead', 'pnl_16_depreciation_overhead', 'pnl_17_recharge_overhead', 'pnl_18_production', 'pnl_19_it_admin'
        ];


        // =================================================================
        // LOGISTIK BERECHNUNG (Controller Logik)
        // =================================================================
        function calculateDetailedLogistics(grossRevenueNet, logCosts, returnRate) {
            const returnFactor = 1 - (returnRate / 100);
            
            // Logistik-Basis-KPIs
            const netASP = (logCosts.avgVKBrutto || 0) / (1 + (logCosts.vatRate || 0) / 100);
            const ipo = logCosts.ipo || 1; 
            const ipr = logCosts.ipr || 1;

            // Berechnung der Netto verkauften Artikel (aus Umsatz fakturiert)
            const grossItemsSoldNet = grossRevenueNet / (netASP > 0 ? netASP : 1);
            
            // Berechnung der Brutto bestellten Artikel (die Logik leitet Brutto aus Netto ab)
            const orderedItemsGross_corrected = returnFactor > 0 ? grossItemsSoldNet / returnFactor : 0; 

            // Abgeleitete Metriken
            const ordersVolume = orderedItemsGross_corrected / ipo;
            const returnItems = orderedItemsGross_corrected - grossItemsSoldNet;
            const returnShipments = returnItems / ipr; 

            // 1. Logistikkosten (P&L 6)
            const totalOrderProcessingCost = ordersVolume * (logCosts.orderProcessingCostPerOrder || 0);
            const totalPickPackCost = orderedItemsGross_corrected * (logCosts.pickPackCostPerItem || 0);
            const totalGoodsReceiptCost = orderedItemsGross_corrected * (logCosts.goodsReceiptCostPerItem || 0);
            const totalReturnProcessingCost = returnItems * (logCosts.returnProcessingCostPerItem || 0);
            const totalStorageCost = orderedItemsGross_corrected * (logCosts.storageCostPerItemPerMonth || 0) * (logCosts.avgStorageDurationMonths || 0);

            const Logistikkosten = 
                totalOrderProcessingCost + 
                totalPickPackCost + 
                totalGoodsReceiptCost +
                totalReturnProcessingCost +
                totalStorageCost;
            
            // 2. Ausgangsfracht (P&L 7)
            const Ausgangsfracht = ordersVolume * (logCosts.shippingCostOut || 0);

            // 3. Retourenfracht (P&L 8)
            const Retourenfracht = returnShipments * (logCosts.shippingCostReturnShipment || 0);

            return { Logistikkosten, Ausgangsfracht, Retourenfracht, ordersVolume, orderedItemsGross_corrected, returnItems };
        }

        // =================================================================
        // P&L BERECHNUNGSKERN
        // =================================================================
        function calculateSinglePnl(inputs, logCosts, currentKPIs, isCalculatedLogistics) {
            const PNL = {};
            
            // 1. INPUTS & VARS
            const vatRate = inputs.pnl_kpi_vat_rate;
            const vatFactor = 1 + vatRate / 100;
            
            // Aus aktuellen KPIs (k√∂nnen durch Projekte ver√§ndert sein)
            const returnRate = currentKPIs.returnRate;
            const cogsRate = currentKPIs.wareneinsatzRate;
            
            // 2. TOPLINE & DB1
            PNL.pnl_1_order_value = currentKPIs.orderValueBrutto; // Bestellwert Brutto
            
            const netOrderValue = PNL.pnl_1_order_value / vatFactor; // Bestellwert Netto
            
            PNL.pnl_2_mwst = PNL.pnl_1_order_value - netOrderValue; // MwSt.
            PNL.pnl_3_revenue_fakturiert = netOrderValue * (1 - returnRate / 100); // Umsatz fakturiert (Netto)
            
            // NEU: Setze die KPI in der PNL
            PNL.pnl_kpi_return_rate = returnRate;

            PNL.pnl_4_other_rev = inputs.pnl_4_other_rev; // Sonstige Erl√∂se (Nominaler Input)
            
            PNL.pnl_5_cogs = PNL.pnl_3_revenue_fakturiert * (cogsRate / 100); // Wareneinsatz
            
            const GrossMargin = PNL.pnl_3_revenue_fakturiert + PNL.pnl_4_other_rev;
            PNL.DB1 = GrossMargin - PNL.pnl_5_cogs;

            // 3. LOGISTIK & DB2
            let LogisticsResult = {};
            // NEU: Toggle-Logik
            if (isCalculatedLogistics) {
                LogisticsResult = calculateDetailedLogistics(PNL.pnl_3_revenue_fakturiert, logCosts, returnRate);
                
                // Frachtkosten-Senkung anwenden (Direkter nominaler Effekt auf die Frachtkosten)
                const freightReductionFactor = 1 - (currentKPIs.freightCostReduction / 100);

                PNL.pnl_6_log_cost = LogisticsResult.Logistikkosten; // Logistikkosten (P&P, OPC etc.)
                PNL.pnl_7_shipping_out = LogisticsResult.Ausgangsfracht * freightReductionFactor; // Ausgangsfracht (reduziert)
                PNL.pnl_8_shipping_return = LogisticsResult.Retourenfracht * freightReductionFactor; // Retourenfracht (reduziert)
            } else {
                // Nimm die manuellen T=0 Werte
                PNL.pnl_6_log_cost = inputs.pnl_6_log_cost;
                PNL.pnl_7_shipping_out = inputs.pnl_7_shipping_out;
                PNL.pnl_8_shipping_return = inputs.pnl_8_shipping_return;
                // Logistik-Ergebnis f√ºr KPI-Tabelle (hier 0, da manuell)
                LogisticsResult = { ordersVolume: 0 }; 
            }
            
            const TotalLogistics = PNL.pnl_6_log_cost + PNL.pnl_7_shipping_out + PNL.pnl_8_shipping_return;
            PNL.DB2 = PNL.DB1 - TotalLogistics;
            
            // 4. DIREKTE KOSTEN & DB3 (Pers. Dir. reduziert)
            const personnelDirectReductionFactor = 1 - (currentKPIs.personnelCostReduction / 100);
            const rechargeDirectReductionFactor = 1 - (currentKPIs.rechargeCostReduction / 100);

            PNL.pnl_9_sales_cost = inputs.pnl_9_sales_cost;
            PNL.pnl_10_personnel_direct = inputs.pnl_10_personnel_direct * personnelDirectReductionFactor; 
            PNL.pnl_11_material_cost = inputs.pnl_11_material_cost; 
            PNL.pnl_12_depreciation_direct = inputs.pnl_12_depreciation_direct; 
            PNL.pnl_13_recharge_direct = inputs.pnl_13_recharge_direct * rechargeDirectReductionFactor; 
            
            const TotalDirectCost = PNL.pnl_9_sales_cost + PNL.pnl_10_personnel_direct + PNL.pnl_11_material_cost + PNL.pnl_12_depreciation_direct + PNL.pnl_13_recharge_direct;
            PNL.DB3 = PNL.DB2 - TotalDirectCost;
            
            // 5. GEMEINKOSTEN & ERGEBNIS (Marketing, Pers. Over., Verrechnung Overhead reduziert)
            const marketingReductionFactor = 1 - (currentKPIs.marketingCostReduction / 100);

            // Annahme: Alle Personalkosten (Dir & Overhead) werden durch den gleichen Faktor reduziert
            PNL.pnl_14_marketing = inputs.pnl_14_marketing * marketingReductionFactor;
            PNL.pnl_15_personnel_overhead = inputs.pnl_15_personnel_overhead * personnelDirectReductionFactor; 
            PNL.pnl_16_depreciation_overhead = inputs.pnl_16_depreciation_overhead;
            PNL.pnl_17_recharge_overhead = inputs.pnl_17_recharge_overhead * rechargeDirectReductionFactor; 
            PNL.pnl_18_production = inputs.pnl_18_production;
            PNL.pnl_19_it_admin = inputs.pnl_19_it_admin;

            const TotalOverhead = PNL.pnl_14_marketing + PNL.pnl_15_personnel_overhead + PNL.pnl_16_depreciation_overhead + PNL.pnl_17_recharge_overhead + PNL.pnl_18_production + PNL.pnl_19_it_admin;
            PNL.RESULT = PNL.DB3 - TotalOverhead;

            return { PNL, LogisticsResult };
        }

        // =================================================================
        // AGGREGATION DER PROJEKT-EFFEKTE (NEU)
        // =================================================================
        function aggregateProjectEffects(streamFilter = 'Alle') {
            // Initialisiert ein leeres Objekt f√ºr die Summe der Effekte
            const aggregatedEffects = {};
            KPI_INPUT_EFFECTS.forEach(effect => {
                aggregatedEffects[effect.id] = {};
                for (let t = 1; t <= PLANNING_HORIZON; t++) {
                    aggregatedEffects[effect.id][t] = 0; // Starte jedes Jahr bei 0
                }
            });

            // Iteriere √ºber alle importierten Projekte
            for (let i = 0; i < importedProjects.length; i++) {
                const project = importedProjects[i];
                // KORREKTUR: Robuste Stream-Erkennung
                const projectStream = project["Business Stream"] || project["Business stream"] || project["BusinessStream"] || "N/A";

                // Wende Effekte nur an, wenn der Filter passt
                if (streamFilter === 'Alle' || projectStream === streamFilter) {
                    
                    // Iteriere √ºber alle m√∂glichen Effekt-Typen (Bestellwert, Retoure, etc.)
                    KPI_INPUT_EFFECTS.forEach(effect => {
                        // Iteriere √ºber alle 5 Planungsjahre
                        for (let t = 1; t <= PLANNING_HORIZON; t++) {
                            // Lese den Wert aus dem spezifischen Input-Feld des Projekts
                            const inputId = `project_${i}_${effect.id}_T${t}`;
                            // NEU: Verwende den globalen Speicher 'projectInputValues'
                            const projectEffectValue = projectInputValues[inputId] || 0;
                            
                            // Addiere den Effekt des Projekts zur Gesamtsumme dieses Jahres
                            aggregatedEffects[effect.id][t] += projectEffectValue;
                        }
                    });
                }
            }
            return aggregatedEffects;
        }


        // =================================================================
        // GESAMTBERECHNUNG (5 JAHRE)
        // =================================================================
        function calculateCase() {
            
            // --- 1. P&L INPUTS T=0 (Basis) ---
            // KORREKTUR: Liest jetzt alle detaillierten Inputs
            const inputsT0 = {};
            BASE_INPUT_IDS.forEach(id => {
                inputsT0[id] = getInputValue(id);
            });
            // F√ºge die restlichen KPIs hinzu, die aus dem Logistik-Tab stammen
            inputsT0.pnl_kpi_avg_vk = getInputValue('log_aspBrutto');
            inputsT0.pnl_kpi_ipo = getInputValue('log_ipo');

            
            // --- 2. BASIS LOGISTIK KOSTEN (NEU: Dynamisch aus Logistik-Tab) ---
            const baseLogisticsCosts = {
                vatRate: inputsT0.pnl_kpi_vat_rate, 
                avgVKBrutto: inputsT0.pnl_kpi_avg_vk, 
                ipo: inputsT0.pnl_kpi_ipo, 
                ipr: getInputValue('log_ipr'), 
                shippingCostOut: getInputValue('log_shippingCostOut'), 
                shippingCostReturnShipment: getInputValue('log_shippingCostReturnShipment'),
                orderProcessingCostPerOrder: getInputValue('log_orderProcessingCostPerOrder'), 
                pickPackCostPerItem: getInputValue('log_pickPackCostPerItem'), 
                goodsReceiptCostPerItem: getInputValue('log_goodsReceiptCostPerItem'),
                returnProcessingCostPerItem: getInputValue('log_returnProcessingCostPerItem'), 
                storageCostPerItemPerMonth: getInputValue('log_storageCostPerItemPerMonth'), 
                avgStorageDurationMonths: getInputValue('log_avgStorageDurationMonths'),
            };
            
            // --- 3. AGGREGIERTE PROJEKT-EFFEKTE (NEU) ---
            // KORREKTUR: Lese den Stream-Filter-Wert
            const streamFilter = document.getElementById('streamFilterSelector')?.value || 'Alle';
            const aggregatedEffects = aggregateProjectEffects(streamFilter);

            // --- 4. AKTUELLE KPI-WERTE (Basis f√ºr T=0) ---
            let CURRENT_KPI_BASE = {
                orderValueBrutto: inputsT0.pnl_1_order_value,
                avgVKBrutto: inputsT0.pnl_kpi_avg_vk,
                itemsPerOrder: inputsT0.pnl_kpi_ipo,
                returnRate: inputsT0.pnl_kpi_return_rate,
                wareneinsatzRate: inputsT0.pnl_kpi_cogs_rate,
                freightCostReduction: 0, 
                personnelCostReduction: 0,
                marketingCostReduction: 0,
                rechargeCostReduction: 0,
            };
            
            // --- 5. 5-JAHRES BERECHNUNG ---
            const PNL_YEARS = {}; // Speichert PNL f√ºr jedes Jahr (T0, T1, ..., T5)
            const KPI_YEARS = {}; // Speichert KPIs f√ºr jedes Jahr
            
            // NEU: Logistik-Toggle-Status
            const logisticsToggle = document.getElementById('logisticsToggle');
            const isCalculatedLogistics = logisticsToggle ? logisticsToggle.checked : true;

            // T=0 ist die Basis
            const T0_Result = calculateSinglePnl(inputsT0, baseLogisticsCosts, CURRENT_KPI_BASE, isCalculatedLogistics);
            PNL_YEARS[0] = T0_Result.PNL;
            KPI_YEARS[0] = { 
                ...CURRENT_KPI_BASE,
                ordersVolume: T0_Result.LogisticsResult.ordersVolume,
                returnRate: inputsT0.pnl_kpi_return_rate,
                marketingKUR: (inputsT0.pnl_14_marketing) / (PNL_YEARS[0].pnl_3_revenue_fakturiert || 1) * 100, 
                personnelRate: (inputsT0.pnl_10_personnel_direct + inputsT0.pnl_15_personnel_overhead) / (PNL_YEARS[0].pnl_3_revenue_fakturiert || 1) * 100
            };
            
            // T=1 bis T=5
            let currentKPIs = { ...CURRENT_KPI_BASE };
            let logisticsCostsT = { ...baseLogisticsCosts };

            for (let t = 1; t <= PLANNING_HORIZON; t++) {
                
                // 5.1. AKKUMULATION DER KPI-EFFEKTE (J√§hrlicher Boost/Reduktion auf Basis des Vorjahres)
                
                // **Wirkung 1: Bestellwert-Boost**
                const orderValueBoostPct = aggregatedEffects.orderValueBoost[t] / 100;
                currentKPIs.orderValueBrutto = currentKPIs.orderValueBrutto * (1 + orderValueBoostPct);

                // **Wirkung 5 & 6: Durchschnitts-VK / IPO Boost** (Ver√§ndern die Logistik-Basis)
                const avgVKBoostPct = aggregatedEffects.avgVKBoost[t] / 100;
                const ipoBoostPct = aggregatedEffects.ipoBoost[t] / 100;

                currentKPIs.avgVKBrutto = currentKPIs.avgVKBrutto * (1 + avgVKBoostPct);
                currentKPIs.itemsPerOrder = currentKPIs.itemsPerOrder * (1 + ipoBoostPct);
                
                // **Wirkung 2: Retourenquote Senkung** (Wird von p.p. [Prozentpunkte] abgezogen)
                const returnRateReductionPP = aggregatedEffects.returnRateReduction[t];
                currentKPIs.returnRate = Math.max(0, currentKPIs.returnRate - returnRateReductionPP); // Kann nicht negativ sein

                // **Wirkung 3, 4, 7, 8: Kosten-Reduktion** (Wird als prozentualer Reduktionsfaktor gespeichert)
                currentKPIs.freightCostReduction = currentKPIs.freightCostReduction + aggregatedEffects.freightCostReduction[t];
                currentKPIs.personnelCostReduction = currentKPIs.personnelCostReduction + aggregatedEffects.personnelCostReduction[t];
                currentKPIs.marketingCostReduction = currentKPIs.marketingCostReduction + aggregatedEffects.marketingCostReduction[t];
                currentKPIs.rechargeCostReduction = currentKPIs.rechargeCostReduction + aggregatedEffects.rechargeCostReduction[t];

                // 5.2. Logistik-Szenario anwenden (KORREKTUR: ENTFERNT)
                
                // Die aktuellen KPIs werden in die Logistikkosten-Struktur f√ºr die Berechnung √ºbernommen
                logisticsCostsT.avgVKBrutto = currentKPIs.avgVKBrutto;
                logisticsCostsT.ipo = currentKPIs.itemsPerOrder;
                logisticsCostsT.vatRate = inputsT0.pnl_kpi_vat_rate; // MwSt. bleibt gleich

                // 5.3. Endg√ºltige PNL f√ºr das Jahr berechnen
                // HINWEIS: T+1 bis T+5 verwenden IMMER die berechnete Logik
                const Year_T_Result = calculateSinglePnl(inputsT0, logisticsCostsT, currentKPIs, true); // true = berechnet
                PNL_YEARS[t] = Year_T_Result.PNL;
                
                // 5.4. KPI-Werte speichern
                KPI_YEARS[t] = {
                    ...currentKPIs,
                    ordersVolume: Year_T_Result.LogisticsResult.ordersVolume,
                    marketingKUR: (PNL_YEARS[t].pnl_14_marketing || 0) / (PNL_YEARS[t].pnl_3_revenue_fakturiert || 1) * 100, 
                    personnelRate: ( (PNL_YEARS[t].pnl_10_personnel_direct || 0) + (PNL_YEARS[t].pnl_15_personnel_overhead || 0) ) / (PNL_YEARS[t].pnl_3_revenue_fakturiert || 1) * 100,
                    wareneinsatzRate: currentKPIs.wareneinsatzRate, // COGS-Rate wird hier als statischer Input betrachtet
                };
            }
            
            // --- 6. DOM AKTUALISIEREN ---
            renderPnlTable(PNL_YEARS);
            renderKpiTable(KPI_YEARS);
            
            // NEU: Logistik-Tab-Rechner aktualisieren
            calculateLogisticsTab(inputsT0, baseLogisticsCosts);
        }

        // =================================================================
        // NEU: LOGISTIK-TAB RECHNER (f√ºr T=0 Vorschau)
        // =================================================================
        function calculateLogisticsTab(inputsT0, baseLogisticsCosts) {
             try {
                // Diese Funktion berechnet die T=0 Logistik-Vorschau basierend auf den aktuellen
                // T=0 P&L Inputs und den T=0 Logistik-Parametern.
                
                const returnRate = inputsT0.pnl_kpi_return_rate;
                const vatFactor = 1 + (inputsT0.pnl_kpi_vat_rate / 100);

                // Berechne T=0 Nettoumsatz (Basis f√ºr Logistik-Berechnung)
                const netOrderValue = inputsT0.pnl_1_order_value / vatFactor;
                const t0_netRevenue = netOrderValue * (1 - returnRate / 100);

                const result = calculateDetailedLogistics(t0_netRevenue, baseLogisticsCosts, returnRate);
                
                const totalCosts = result.Logistikkosten + result.Ausgangsfracht + result.Retourenfracht;
                
                document.getElementById('log_calc_bestellungen').textContent = formatterNumber.format(result.ordersVolume);
                document.getElementById('log_calc_netto_umsatz').textContent = formatterEuro.format(t0_netRevenue);
                document.getElementById('log_calc_gesamtkosten').textContent = formatterEuro.format(totalCosts);
                
                const costPercent = (t0_netRevenue > 0) ? (totalCosts / t0_netRevenue) : 0;
                document.getElementById('log_calc_kosten_pro_netto_umsatz').textContent = formatterPercent.format(costPercent);
                
                const costPerOrder = (result.ordersVolume > 0) ? (totalCosts / result.ordersVolume) : 0;
                document.getElementById('log_calc_kosten_pro_bestellung').textContent = formatterEuro2Dec.format(costPerOrder);

            } catch (e) {
                console.error("Fehler im Logistik-Tab-Rechner:", e);
            }
        }

        // =================================================================
        // RENDERING DER PROJEKT-INPUT-MATRIZEN (Layout korrigiert)
        // =================================================================
        function renderProjectInputs(projects, inputValues = {}) {
            const container = document.getElementById('projectEffectsContainer');
            if (!container) return;
            
            container.innerHTML = ''; // Leere den Platzhalter
            
            projects.forEach((project, index) => {
                const projectName = project.Projektname || `Projekt ${index + 1}`;
                // KORREKTUR: Robuste Stream-Erkennung
                const projectSlogan = project["Inhalt in einem Satz"] || "";
                const businessStream = project["Business Stream"] || project["Business stream"] || project["BusinessStream"] || "N/A";
                
                let projectHtml = `
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200" data-business-stream="${businessStream}">
                        <h3 class="text-xl font-bold text-indigo-600 mb-1">${projectName}</h3>
                        
                        <!-- NEU: Projekt-Meta-Daten -->
                        <p class="text-sm text-gray-500 mb-3 italic">"${projectSlogan}"</p>
                        <p class="text-xs font-semibold text-indigo-500 bg-indigo-100 rounded-full px-3 py-1 inline-block mb-4">Stream: ${businessStream}</p>
                        
                        <!-- KORREKTUR: KI-Funktion wiederhergestellt -->
                        <div class="mb-4">
                            <label for="ai-input-${index}" class="block text-sm font-medium text-gray-700 mb-1">Qualitative Effekt-Steuerung (KI-gest√ºtzt)</label>
                            <div class="flex items-center space-x-2">
                                <textarea id="ai-input-${index}" class="ai-textarea flex-grow" rows="2" placeholder="z.B. 5% Effekt auf den Bestellwert in den ersten drei jahren"></textarea>
                                <button id="ai-button-${index}" onclick="handleAiParse(${index}, 'ai-input-${index}')" class="ai-parse-button">
                                    KI Parse
                                </button>
                                <div id="ai-spinner-${index}" class="hidden spinner"></div>
                            </div>
                        </div>
                        
                        <div class="table-container kpi-input-grid grid-cols-kpi-input-projects">
                `;

                // Header f√ºr diese Projekt-Matrix
                projectHtml += `
                    <div class="grid-cell grid-header grid-sticky-col" style="left: 0px;">Projektname</div>
                    <div class="grid-cell grid-header grid-sticky-col" style="left: 220px; z-index: 11;">Wirkung (KPI)</div> <!-- Zweite sticky Spalte -->
                    <div class="grid-cell grid-header text-right">T+1</div>
                    <div class="grid-cell grid-header text-right">T+2</div>
                    <div class="grid-cell grid-header text-right">T+3</div>
                    <div class="grid-cell grid-header text-right">T+4</div>
                    <div class="grid-cell grid-header text-right">T+5</div>
                `;

                // Iteriere √ºber alle Projekte UND dann √ºber alle Effekte
                KPI_INPUT_EFFECTS.forEach((effect, effectIndex) => {
                    
                    // Erste Spalte: Projektname (nur bei der ersten Effekt-Zeile anzeigen und √ºber alle Effekt-Zeilen spannen)
                    if (effectIndex === 0) {
                        projectHtml += `<div class="grid-cell grid-sticky-col" style="left: 0px; grid-row: span ${KPI_INPUT_EFFECTS.length}; align-self: center; background-color: #f9fafb;">${projectName}</div>`;
                    }

                    // Zweite Spalte: Effekt-Label
                    projectHtml += `<div class="grid-cell grid-sticky-col" style="left: 220px; z-index: 11; background-color: #fefce8;">${effect.label}</div>`;

                    // Jahres-Inputfelder
                    for (let t = 1; t <= PLANNING_HORIZON; t++) {
                        // Eindeutige ID pro Projekt und Effekt: project_INDEX_EFFECTID_JAHR
                        const inputId = `project_${index}_${effect.id}_T${t}`;
                        
                        // NEU: Werte aus 'inputValues' (geladen) oder Excel oder 0.0
                        let value = 0.0;
                        if (inputValues[inputId] !== undefined) {
                            value = inputValues[inputId]; // Nimm den gespeicherten Wert
                        } else {
                            const excelKey = `${effect.id}_T${t}`; // Lese den Wert aus der Excel-Datei
                            value = project[excelKey] || 0.0; 
                        }
                        
                        // Speichere den Initialwert im globalen Objekt
                        projectInputValues[inputId] = value;

                        projectHtml += `<div class="grid-cell">
                                    <input type="text" id="${inputId}" value="${formatterFloat1.format(value)}" data-raw-value="${value}" onfocus="unformatInput(this)" onblur="formatInput(this, 'float', 1)" class="formatted">
                                 </div>`;
                    }
                });
                
                projectHtml += `</div></div>`; // Ende der Projekt-Matrix
                container.innerHTML += projectHtml;
            });
        }

        // NEU: Funktion zum Speichern von Projekt-Input-√Ñnderungen
        function updateProjectInputValue(inputId, value) {
            // Beim √Ñndern eines Projekt-Inputs, speichere den Rohwert und berechne neu
            const element = document.getElementById(inputId);
            if (element) {
                // Ersetze Komma durch Punkt f√ºr JS-Verarbeitung
                const cleanValue = element.value.replace(/[^0-9,-]+/g, '').replace(',', '.');
                element.dataset.rawValue = parseFloat(cleanValue) || 0;
            }
            // KORREKTUR: Speichere den Rohwert im globalen Objekt
            projectInputValues[inputId] = parseFloat(element.dataset.rawValue) || 0;
            
            // KORREKTUR: Rufe calculateCase() auf, wenn ein Input-Feld (onblur) √ºber formatInput() aktualisiert wird.
            // (formatInput ruft calculateCase auf, aber updateProjectInputValue wird auch von oninput aufgerufen - 
            // stellen wir sicher, dass es hier nicht doppelt aufgerufen wird, sondern nur beim Verlassen des Feldes)
        }
        
        // =================================================================
        // RENDERING DER P&L TABELLE (Layout korrigiert)
        // =================================================================
        function renderPnlTable(PNL_YEARS) {
            const pnlTable = document.getElementById('pnlTable');
            const startYear = getInputValue('startYear') || new Date().getFullYear();

            // 1. Header generieren
            let headerHtml = `<div class="grid-cell grid-header grid-sticky-col">P&L Position</div>`;
            for (let t = 0; t <= PLANNING_HORIZON; t++) {
                headerHtml += `<div class="grid-cell grid-header text-right">${startYear + t} (‚Ç¨)</div>`;
                headerHtml += `<div class="grid-cell grid-header text-right pnl-percent">${startYear + t} (%)</div>`;
            }

            // 2. Body generieren
            let bodyHtml = '';
            PNL_STRUCTURE.forEach(item => {
                if (item.type === 'header') {
                    // Span √ºber alle Spalten (1 Label + 6 Jahre * 2 Spalten = 13)
                    bodyHtml += `<div class="grid-cell pnl-header-row" style="grid-column: 1 / span 13;">${item.label}</div>`;
                    return;
                }

                let rowClass = item.type === 'subtotal' ? 'pnl-subtotal' : item.type === 'final' ? 'pnl-final' : '';
                
                // Erste Spalte: Label
                bodyHtml += `<div class="grid-cell grid-sticky-col ${rowClass}">${item.label}</div>`;

                for (let t = 0; t <= PLANNING_HORIZON; t++) {
                    const pnlYear = PNL_YEARS[t] || {};
                    const value = pnlYear[item.id] || 0;
                    const baseRevenue = pnlYear.pnl_3_revenue_fakturiert || 1;
                    
                    let valueDisplay;
                    let percentDisplay;
                    let valueClass = '';

                    // NEUE LOGIK F√úR KPI-ZEILE
                    if (item.type === 'kpi') {
                        valueDisplay = `${value.toFixed(1)} %`;
                        percentDisplay = 'N/A';
                        valueClass = 'font-semibold bg-yellow-50';
                    } else {
                        valueDisplay = formatterEuro.format(value);
                        
                        if (item.id === 'pnl_1_order_value' || item.id === 'pnl_2_mwst') {
                             percentDisplay = 'N/A';
                        } else if (item.id === 'pnl_3_revenue_fakturiert') {
                             percentDisplay = formatterPercent.format(1); // Umsatz ist immer 100% seiner selbst
                        } else {
                            percentDisplay = formatterPercent.format(value / baseRevenue);
                        }
                    }
                    
                    if (item.type === 'final' || item.type === 'subtotal') {
                        valueClass = 'font-bold';
                        if (t > 0 && value < (PNL_YEARS[t-1]?.[item.id] || 0)) valueClass += ' text-red-600';
                        if (t > 0 && value > (PNL_YEARS[t-1]?.[item.id] || 0)) valueClass += ' text-green-600';
                    } else if (item.isCost) {
                        if (t > 0) {
                            valueClass = value > (PNL_YEARS[t-1]?.[item.id] || 0) ? 'text-red-600' : 'text-green-600';
                        }
                    }

                    bodyHtml += `<div class="grid-cell text-right ${rowClass} ${valueClass}">${valueDisplay}</div>`;
                    bodyHtml += `<div class="grid-cell text-right pnl-percent ${rowClass}">${percentDisplay}</div>`;
                }
            });
            
            // 3. HTML injizieren
            pnlTable.innerHTML = headerHtml + bodyHtml;
        }

        // =================================================================
        // RENDERING DER KPI TABELLE (Layout korrigiert)
        // =================================================================
        function renderKpiTable(KPI_YEARS) {
            const kpiTable = document.getElementById('kpiTable');
            const startYear = getInputValue('startYear') || new Date().getFullYear();

            // 1. Header generieren
            let headerHtml = `<div class="grid-cell grid-header grid-sticky-col">KPI</div>`;
            for (let t = 0; t <= PLANNING_HORIZON; t++) {
                headerHtml += `<div class="grid-cell grid-header text-right">${startYear + t}</div>`;
            }

            // 2. Body generieren
            let bodyHtml = '';
            KPI_STRUCTURE.forEach(item => {
                // Erste Spalte: Label
                bodyHtml += `<div class="grid-cell grid-sticky-col kpi-row">${item.label}</div>`;

                for (let t = 0; t <= PLANNING_HORIZON; t++) {
                    const kpiYear = KPI_YEARS[t] || {};
                    const value = kpiYear[item.id] || 0;
                    
                    let valueDisplay;
                    let valueClass = '';

                    if (item.id === 'returnRate' || item.id === 'marketingKUR' || item.id === 'personnelRate' || item.id === 'wareneinsatzRate') {
                        valueDisplay = `${value.toFixed(1)} %`;
                    } else if (item.id === 'ordersVolume') {
                        valueDisplay = formatterNumber.format(value);
                    } else if (item.id === 'itemsPerOrder') {
                         valueDisplay = value.toFixed(2);
                    } else {
                        valueDisplay = formatterEuro.format(value);
                    }
                    
                    if (t > 0) {
                         const t0Value = KPI_YEARS[0]?.[item.id] || 0;
                         if (item.id === 'returnRate' || item.id === 'marketingKUR' || item.id === 'personnelRate' || item.id === 'wareneinsatzRate') {
                            valueClass = value < t0Value ? 'text-green-600 font-semibold' : value > t0Value ? 'text-red-600 font-semibold' : '';
                         } else {
                            valueClass = value > t0Value ? 'text-green-600 font-semibold' : value < t0Value ? 'text-red-600 font-semibold' : '';
                         }
                    }

                    bodyHtml += `<div class="grid-cell text-right kpi-row ${valueClass}">${valueDisplay}</div>`;
                }
            });
            
            // 3. HTML injizieren
            kpiTable.innerHTML = headerHtml + bodyHtml;
        }

        // =================================================================
        // DATEI-UPLOAD LOGIK
        // =================================================================
        
        // NEU: Generische Upload-Funktion
        function setupExcelUpload(inputId, statusId, callback) {
            const fileInput = document.getElementById(inputId);
            if (!fileInput) return;
            
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                const statusEl = document.getElementById(statusId);
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        
                        // Rufe die spezifische Callback-Funktion auf
                        callback(json, statusEl);

                    } catch (error) {
                        console.error(`Fehler beim Lesen der Excel-Datei (${inputId}):`, error);
                        if (statusEl) statusEl.innerHTML = '<span class="text-red-600">Fehler: Datei konnte nicht gelesen werden.</span>';
                    }
                };
                reader.readAsArrayBuffer(file);
                // Wichtig: Input zur√ºcksetzen, damit dieselbe Datei erneut geladen werden kann
                event.target.value = null;
            });
        }

        // Callback f√ºr Projekt-Upload
        function handleProjectUploadCallback(json, statusEl) {
            importedProjects = json;
            statusEl.innerHTML = `<span class="text-green-600">Erfolgreich geladen: ${importedProjects.length} Projekte.</span>`;
            projectInputValues = {}; // Setze Anpassungen zur√ºck
            renderProjectInputs(importedProjects, projectInputValues);
            
            // NEU: F√ºlle den Stream-Filter
            populateStreamFilter(importedProjects);

            calculateCase(); // Neuberechnung mit Projekt-Daten
        }

        // Callback f√ºr Basis-Input-Upload
        function handleBaseInputsUploadCallback(json, statusEl) {
            let count = 0;
            json.forEach(row => {
                // Erwartet Spalten "Parameter" (ID) und "Wert"
                if (row.Parameter && row.Wert !== undefined) {
                    setInputValue(row.Parameter, row.Wert); // Setzt den formatierten Wert
                    count++;
                }
            });
            statusEl.innerHTML = `<span class="text-green-600">Erfolgreich ${count} Basis-Parameter geladen.</span>`;
            calculateCase();
        }
        
        // NEU: F√ºllt den Stream-Filter
        function populateStreamFilter(projects) {
            const selector = document.getElementById('streamFilterSelector');
            if (!selector) return;

            const streams = new Set();
            projects.forEach(p => {
                // KORREKTUR: Robuste Stream-Erkennung
                const stream = p["Business Stream"] || p["Business stream"] || p["BusinessStream"];
                if (stream) {
                    streams.add(stream);
                }
            });
            
            selector.innerHTML = '<option value="Alle">Alle Streams</option>'; // Beginne frisch
            
            streams.forEach(stream => {
                const option = document.createElement('option');
                option.value = stream;
                option.textContent = stream;
                selector.appendChild(option);
            });
        }


        // =================================================================
        // SZENARIO SPEICHERN & LADEN
        // =================================================================
        
        // Speichern-Button Event Listener
        document.getElementById('saveScenarioBtn')?.addEventListener('click', async () => {
            if (!isAuthReady || !db) {
                alert('Firebase ist nicht verbunden. Speichern nicht m√∂glich.');
                return;
            }
            const scenarioName = document.getElementById('scenarioNameInput')?.value;
            if (!scenarioName) {
                alert('Bitte geben Sie einen Szenario-Namen ein.');
                return;
            }

            // KORREKTUR: Speichert ALLE relevanten Daten
            const scenarioData = {
                scenarioName: scenarioName,
                createdAt: new Date().toISOString(),
                userId: userId,
                // T=0 Basis-Inputs
                baseInputs: {},
                // NEU: Logistik-Inputs
                logisticsInputs: {},
                // NEU: Logistik-Toggle-Status
                logisticsToggleChecked: document.getElementById('logisticsToggle').checked,
                // Die Rohdaten der Excel-Datei
                importedProjects: importedProjects,
                // Alle Anpassungen, die in den Projekt-Matrizen vorgenommen wurden
                projectInputValues: projectInputValues 
            };
            
            // F√ºlle baseInputs
            BASE_INPUT_IDS.forEach(id => {
                scenarioData.baseInputs[id] = getInputValue(id);
            });
            // F√ºlle logisticsInputs
            LOGISTICS_INPUT_IDS.forEach(id => {
                scenarioData.logisticsInputs[id] = getInputValue(id);
            });


            try {
                // KORREKTUR: Pr√ºfen, ob ein Szenario mit diesem Namen bereits existiert
                const q = query(collection(db, BUSINESS_CASES_COLLECTION), where("scenarioName", "==", scenarioName));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // ------ NEUES SZENARIO ERSTELLEN ------
                    const docRef = await addDoc(collection(db, BUSINESS_CASES_COLLECTION), scenarioData);
                    document.getElementById('scenarioStatus').textContent = `Business Case "${scenarioName}" gespeichert.`;
                    alert(`Business Case "${scenarioName}" erfolgreich gespeichert!`);
                } else {
                    // ------ BESTEHENDES SZENARIO √úBERSCHREIBEN ------
                    const existingDocId = querySnapshot.docs[0].id;
                    const docRef = doc(db, BUSINESS_CASES_COLLECTION, existingDocId);
                    await setDoc(docRef, scenarioData, { merge: true }); // √úberschreibt
                    
                    document.getElementById('scenarioStatus').textContent = `Business Case "${scenarioName}" aktualisiert.`;
                    alert(`Business Case "${scenarioName}" erfolgreich aktualisiert!`);
                }

            } catch (error) {
                console.error("Fehler beim Speichern des Szenarios: ", error);
                let errorMsg = 'Fehler beim Speichern!';
                if (error.code === 'permission-denied') {
                    errorMsg = 'Fehler: Zugriff verweigert. Bitte Firestore-Regeln f√ºr "business_cases" (Schreibzugriff) pr√ºfen!';
                }
                document.getElementById('scenarioStatus').textContent = errorMsg;
                alert(errorMsg);
            }
        });

        // KORREKTUR: Logistik-Szenario-Laden ENTFERNT
        let logisticsSnapshotListener = null;
        function loadScenariosListener() {
           if (logisticsSnapshotListener) logisticsSnapshotListener(); // Detach old
           // Diese Funktion ist jetzt leer, da das Dropdown entfernt wurde.
        }

        // NEU: Business Case-Liste laden
        let businessCaseSnapshotListener = null; // KORREKTUR: Guard f√ºr Duplikate
        function loadBusinessCasesListener() {
            if (!db) return;
            if (businessCaseSnapshotListener) businessCaseSnapshotListener(); // KORREKTUR: Detach
            
            const casesQuery = query(collection(db, BUSINESS_CASES_COLLECTION));
            
            businessCaseSnapshotListener = onSnapshot(casesQuery, (snapshot) => { // KORREKTUR: Attach
                const selector = document.getElementById('caseSelector');
                if (!selector) return;
                const selectedValue = selector.value;
                
                selector.innerHTML = '<option value="">--- Business Case laden ---</option>';

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.scenarioName || `Case ${doc.id.substring(0,5)}`;
                    if (doc.id === selectedValue) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
                
            }, (error) => {
                console.error("Fehler beim Laden der Business Case-Liste: ", error);
                if (error.code === 'permission-denied') {
                     alert('Fehler: Zugriff verweigert. Bitte Firestore-Regeln f√ºr "business_cases" (Lesezugriff) pr√ºfen!');
                }
            });
        }

        // KORREKTUR: Logistik-Szenario-Laden ENTFERNT
        async function loadScenarioData(docId) {
             // Diese Funktion ist jetzt leer
        }

        // NEU: Einen spezifischen Business Case laden
        async function loadBusinessCase(docId) {
            const caseSpinner = document.getElementById('caseSpinner');
            if (!db || !docId) {
                return;
            }
            
            caseSpinner.classList.remove('hidden');

            try {
                const docRef = doc(db, BUSINESS_CASES_COLLECTION, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Lade T=0 Basis-Inputs
                    const inputs = data.baseInputs || {};
                    Object.keys(inputs).forEach(key => {
                        setInputValue(key, inputs[key]);
                    });
                    
                    // 2. Lade Logistik-Inputs
                    const logInputs = data.logisticsInputs || {};
                    Object.keys(logInputs).forEach(key => {
                         setInputValue(key, logInputs[key]);
                    });

                    // 3. Lade Projekt-Daten
                    importedProjects = data.importedProjects || [];
                    projectInputValues = data.projectInputValues || {};
                    
                    // 4. Lade Logistik-Toggle-Status
                    document.getElementById('logisticsToggle').checked = data.logisticsToggleChecked === true;
                    toggleManualLogistics(); // Stellt die Sichtbarkeit der manuellen Felder her

                    // 5. Rendere die Projekt-Inputs mit den geladenen Werten
                    renderProjectInputs(importedProjects, projectInputValues);
                    
                    // KORREKTUR: F√ºlle den Stream-Filter, NACHDEM die Projekte geladen wurden
                    populateStreamFilter(importedProjects);
                    
                    // 6. Setze den Namen
                    document.getElementById('scenarioNameInput').value = data.scenarioName || '';
                    document.getElementById('scenarioStatus').textContent = `Business Case "${data.scenarioName}" geladen.`;
                    
                    calculateCase(); // Neuberechnung mit den geladenen Daten
                } else {
                    document.getElementById('scenarioStatus').textContent = 'Fehler: Business Case nicht gefunden.';
                }
            } catch (error) {
                 console.error("Fehler beim Laden des Business Case: ", error);
                 document.getElementById('scenarioStatus').textContent = 'Fehler beim Laden des Case.';
            } finally {
                caseSpinner.classList.add('hidden');
            }
        }

        // NEU: L√ñSCHFUNKTIONEN
        async function deleteBusinessCase() {
            const selector = document.getElementById('caseSelector');
            const docId = selector.value;
            if (!docId) {
                document.getElementById('scenarioStatus').textContent = 'Kein Case zum L√∂schen ausgew√§hlt.';
                return;
            }
            
            // Simuliere Best√§tigung (da window.confirm verboten ist)
            document.getElementById('scenarioStatus').textContent = `Case "${selector.options[selector.selectedIndex].text}" wirklich l√∂schen? (Klicken Sie erneut zum Best√§tigen)`;
            
            // Einfache "Doppelklick"-Logik als Ersatz f√ºr confirm()
            if (selector.dataset.deletePending === docId) {
                try {
                    await deleteDoc(doc(db, BUSINESS_CASES_COLLECTION, docId));
                    document.getElementById('scenarioStatus').textContent = 'Business Case gel√∂scht.';
                    selector.dataset.deletePending = null;
                } catch (e) {
                    console.error("Fehler beim L√∂schen (Case):", e);
                    document.getElementById('scenarioStatus').textContent = 'Fehler beim L√∂schen.';
                }
            } else {
                selector.dataset.deletePending = docId;
                // Setze den Best√§tigungsstatus nach 3 Sekunden zur√ºck
                setTimeout(() => { 
                    if (selector.dataset.deletePending === docId) {
                         selector.dataset.deletePending = null;
                         document.getElementById('scenarioStatus').textContent = '';
                    }
                }, 3000);
            }
        }

        // KORREKTUR: Logistik-L√∂schen ENTFERNT
        async function deleteLogisticsScenario() {
            // Diese Funktion ist jetzt leer
        }
        
        // KORREKTUR: KI-Funktionen ENTFERNT
        // ... (callGeminiApi, handleAiParse, exponentialBackoff sind entfernt) ...


        // =================================================================
        // STARTPUNKT
        // =================================================================
        window.onload = function() {
            // Globale Funktionen verf√ºgbar machen
            window.calculateCase = calculateCase;
            // KORREKTUR: window.loadScenarioData = loadScenarioData; (entfernt)
            window.loadBusinessCase = loadBusinessCase; 
            window.showTab = showTab;
            window.updateProjectInputValue = updateProjectInputValue; 
            window.toggleManualLogistics = toggleManualLogistics; 
            window.formatInput = formatInput; 
            window.unformatInput = unformatInput; 
            // KORREKTUR: window.handleAiParse = handleAiParse; (entfernt)
            window.handleAiParse = () => { alert("KI-Funktion ist derzeit deaktiviert."); }; // Sicherer Platzhalter

            // Event Listener f√ºr Excel-Uploads
            setupExcelUpload('excelFileProjects', 'projectImportStatus', handleProjectUploadCallback);
            setupExcelUpload('baseInputsExcelFile', 'baseInputsImportStatus', handleBaseInputsUploadCallback);


            // NEU: Event Listener f√ºr Business Case Lade-Dropdown
            document.getElementById('caseSelector')?.addEventListener('change', (e) => loadBusinessCase(e.target.value));
            
            // NEU: Event Listener f√ºr Delete-Buttons
            document.getElementById('deleteCaseBtn')?.addEventListener('click', deleteBusinessCase);
            // KORREKTUR: document.getElementById('deleteLogisticsBtn')?.addEventListener('click', deleteLogisticsScenario); (entfernt)

            initFirebase(); // Startet Firebase UND ruft calculateCase() auf
            toggleManualLogistics(); // Setzt den initialen Zustand des Toggles
        }
    </script>
</body>
</html>

