<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Case Builder (5-Jahre)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx.js) für Excel-Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Basis-Stile */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Layout-Stile für P&L und KPI Tabellen (WICHTIG FÜR DAS LAYOUT) */
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        
        .data-grid {
            display: grid;
        }
        
        /* Definition der Spaltenbreiten (ANGEPASST FÜR 5 JAHRE) */
        .grid-cols-pnl {
            /* 1 fixe Spalte + 6 Jahre (T0-T5) * 2 Spalten (Euro + %) = 13 Spalten */
            grid-template-columns: minmax(240px, 1fr) repeat(12, minmax(110px, 1fr));
            min-width: 1600px; /* Reduziert von 1800px */
        }
        .grid-cols-kpi {
            /* 1 fixe Spalte + 6 Jahre (T0-T5) * 1 Spalte (Wert) = 7 Spalten */
            grid-template-columns: minmax(240px, 1fr) repeat(6, minmax(110px, 1fr));
            min-width: 900px; /* Reduziert */
        }
        
        /* NEUE KLASSE FÜR PROJEKT-IMPORT-TABELLE */
        .grid-cols-kpi-input-projects {
            /* 1 fixe Spalte (Projekt) + 1 fixe Spalte (Wirkung) + 5 Jahre (T1-T5) = 7 Spalten */
            grid-template-columns: minmax(220px, 1fr) minmax(220px, 1fr) repeat(5, minmax(90px, 1fr));
            min-width: 900px;
        }

        /* Zellen-Stile */
        .grid-cell {
            padding: 6px 10px;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.875rem; /* 14px */
        }
        .grid-cell:last-child { border-right: none; }
        
        /* Header-Zellen */
        .grid-header {
            background-color: #f9fafb; /* Leichtes Grau */
            font-weight: 700;
            color: #374151; /* Dunkelgrau */
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        /* Fixierte (Sticky) Spalten-Zellen (Links) */
        .grid-sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #ffffff; /* Weißer Hintergrund, um Überlappung zu verdecken */
            border-right: 2px solid #d1d5db; /* Stärkere Trennlinie */
            font-weight: 500;
        }
        .grid-header.grid-sticky-col {
            z-index: 30; /* Muss über dem Header UND der Spalte sein */
            background-color: #f3f4f6;
        }
        
        .pnl-subtotal > div { background-color: #eff6ff; font-weight: 700; } /* Blau für DBs */
        .pnl-final > div { background-color: #e0e7ff; font-weight: 800; } /* Dunkleres Blau für Ergebnis */
        .pnl-header-row { background-color: #e5e7eb; grid-column: 1 / -1; font-weight: 700; } /* Grau für Sektions-Header */
        .pnl-percent { color: #6b7280; font-size: 0.75rem; } /* %-Werte */
        .kpi-row { background-color: #fdfdff; }
        
        /* KPI Input Matrix Stile */
        .kpi-input-grid { display: grid; }
        .kpi-input-grid .grid-cell { padding: 2px; }
        .kpi-input-grid input {
            padding: 4px; border: none; width: 100%; text-align: right; background-color: transparent;
            font-size: 0.875rem;
        }
        .kpi-input-grid input:focus { outline: 1px solid #3b82f6; }
        .kpi-input-grid .grid-sticky-col { background-color: #fefce8; } /* Gelber Hintergrund für KPI-Label */
        .kpi-input-grid .grid-header { background-color: #fef3c7; } /* Dunkleres Gelb für KPI-Header */

        /* Tab-Stile */
        .tab-button {
            padding: 0.5rem 1rem; /* Kompaktere Tabs */
            border-bottom-width: 2px;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            white-space: nowrap;
        }
        .tab-button.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
        .tab-button.inactive {
            border-color: transparent;
            color: #6b7280; /* gray-500 */
        }
        .tab-button.inactive:hover {
            border-color: #d1d5db; /* gray-300 */
            color: #374151; /* gray-700 */
        }
        /* Style für Lade-Dropdowns */
        .load-dropdown {
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }
        .load-dropdown select {
            flex-grow: 1;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-full mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">
        <header class="mb-8 flex flex-col md:flex-row justify-between md:items-start">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 border-b-4 border-indigo-200 pb-2">
                    Business Case Builder (5-Jahre)
                </h1>
                <p class="text-gray-500 mt-2">Modelliert P&L-Effekte von Projekten über einen flexiblen 5-Jahres-Horizont.</p>
            </div>
            
            <!-- User Info und Status -->
            <div class="text-left md:text-right text-sm mt-4 md:mt-0">
                <p class="font-semibold text-gray-700">Status: <span id="authStatus" class="text-red-600">Initialisiere...</span></p>
                <p class="text-xs text-gray-500 truncate">User ID: <span id="currentUserId">Warte auf Anmeldung...</span></p>
                
                <!-- Speichern/Laden Sektion -->
                <div class="mt-4 flex flex-col md:items-end space-y-2">
                    <!-- Business Case Speichern -->
                    <div class="flex items-center space-x-2 w-full">
                        <input type="text" id="scenarioNameInput" placeholder="Business Case Name" class="w-full md:w-auto rounded-lg border-gray-300 shadow-sm p-2 border-2">
                        <button id="saveScenarioBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                            Speichern
                        </button>
                    </div>
                    
                    <!-- NEU: Business Case Laden -->
                    <div class="load-dropdown">
                         <select id="caseSelector" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            <option value="">--- Business Case laden ---</option>
                        </select>
                        <div id="caseSpinner" class="hidden spinner"></div>
                    </div>

                    <!-- Logistik Szenario Laden -->
                    <div class="load-dropdown">
                         <select id="scenarioSelector" onchange="loadScenarioData(this.value)" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            <option value="">--- Logistik-Szenario laden ---</option>
                        </select>
                        <div id="scenarioSpinner" class="hidden spinner"></div>
                    </div>
                    
                    <div id="scenarioStatus" class="text-xs text-gray-500 text-right w-full"></div>
                </div>

            </div>
        </header>

        <!-- NEU: Tab-Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-pnl" onclick="showTab('pnl')" class="tab-button active">P&L & KPIs</button>
                <button id="tab-projects" onclick="showTab('projects')" class="tab-button inactive">Projekt-Steuerung</button>
            </nav>
        </div>

        <!-- NEU: Tab-Container -->
        <div>
            <!-- Tab 1: P&L & KPIs (Standardansicht) -->
            <div id="pane-pnl">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
                    <!-- Linke Spalte: Eingaben & Steuerung -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- 1. P&L STARTWERTE & ZEITACHSE -->
                        <div class="p-4 bg-indigo-50 rounded-lg shadow-inner space-y-4">
                            <h2 class="text-xl font-bold text-indigo-700">1. Basis & Zeitachse (T=0)</h2>
                            <div class="input-group">
                                <label for="startYear" class="block text-sm font-medium text-gray-700">Start-Jahr (T=0)</label>
                                <input type="number" id="startYear" value="2024" min="2000" max="2100" step="1" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                            <div class="input-group">
                                <label for="pnl_kpi_vat_rate" class="block text-sm font-medium text-gray-700">Mehrwertsteuersatz (MwSt. %)</label>
                                <input type="number" id="pnl_kpi_vat_rate" value="19.0" min="0" max="100" step="0.1" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                            <!-- Aggregierte Eingaben für T=0 (werden im Code aufgesplittet) -->
                            <h3 class="text-md font-semibold text-indigo-700 mt-4">Basis-Werte (Aggregiert T=0)</h3>
                            <div class="input-group">
                                <label for="pnl_1_order_value" class="block text-sm font-medium text-gray-700">Bestellwert (Brutto €)</label>
                                <input type="number" id="pnl_1_order_value" value="1500000" min="0" step="10000" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                            <div class="input-group">
                                <label for="pnl_kpi_return_rate" class="block text-sm font-medium text-gray-700">Retourenquote (%)</label>
                                <input type="number" id="pnl_kpi_return_rate" value="25.0" min="0" max="100" step="0.1" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                            <div class="input-group">
                                <label for="pnl_kpi_cogs_rate" class="block text-sm font-medium text-gray-700">Wareneinsatzquote (%)</label>
                                <input type="number" id="pnl_kpi_cogs_rate" value="40.0" min="0" max="100" step="0.1" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                             <div class="input-group">
                                <label for="pnl_4_other_rev" class="block text-sm font-medium text-gray-700">Sonstige Erlöse (Netto €)</label>
                                <input type="number" id="pnl_4_other_rev" value="10000" min="0" step="100" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                            <div class="input-group">
                                <label for="pnl_9_sales_cost" class="block text-sm font-medium text-gray-700">Direkte Kosten-Basis (€)</label>
                                <input type="number" id="pnl_9_sales_cost" value="130000" min="0" step="1000" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                            <div class="input-group">
                                <label for="pnl_14_marketing" class="block text-sm font-medium text-gray-700">Gemeinkosten-Basis (€)</label>
                                <input type="number" id="pnl_14_marketing" value="200000" min="0" step="1000" oninput="calculateCase()" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 border-2">
                            </div>
                        </div>
                    </div>

                    <!-- Rechte Spalte: Detaillierte P&L Eingabe und Ergebnisse -->
                    <div class="lg:col-span-3 space-y-6">

                        <!-- 3. P&L Ergebnis über 5 Jahre -->
                        <h2 class="text-2xl font-semibold text-gray-700 mt-8 border-b pb-2">3. P&L Ergebnis (T=0 bis T+5)</h2>
                        <div class="table-container">
                            <!-- KORREKTUR: Header und Body werden jetzt von JS direkt hier eingefügt -->
                            <div id="pnlTable" class="data-grid grid-cols-pnl">
                                <!-- JS füllt diesen Container -->
                            </div>
                        </div>

                        <!-- 4. KPI Übersichtstabelle -->
                        <h2 class="text-2xl font-semibold text-gray-700 mt-12 border-b pb-2">4. KPI-Entwicklung (T=0 bis T+5)</h2>
                        <div class="table-container mb-8">
                            <!-- KORREKTUR: Header und Body werden jetzt von JS direkt hier eingefügt -->
                            <div id="kpiTable" class="data-grid grid-cols-kpi">
                                <!-- JS füllt diesen Container -->
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-500 mt-4">Hinweis: Die Logistikkosten basieren in T+1 bis T+5 auf dem geladenen Szenario und den durch den Boost erhöhten Bestellwerten.</p>
                    </div>

                </div>
            </div>

            <!-- Tab 2: Projekt-Steuerung (Standard verborgen) -->
            <div id="pane-projects" class="hidden">
                <div class="max-w-6xl mx-auto space-y-8">
                    <!-- 0. PROJEKTLISTE IMPORTIEREN (Hierher verschoben) -->
                    <div class="p-6 bg-gray-100 rounded-lg shadow-inner border border-gray-300 space-y-4">
                        <h2 class="text-xl font-bold text-indigo-700">0. Projektliste importieren</h2>
                        <label for="excelFile" class="block text-sm font-medium text-gray-700">Wählen Sie Ihre Projektliste (.xlsx):</label>
                        <input type="file" id="excelFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200">
                        
                        <div id="projectImportStatus" class="text-sm text-gray-600 mt-2">
                            Warte auf Datei-Upload (0 Projekte geladen).
                        </div>
                    </div>

                    <!-- 2. IMPORTIERTE PROJEKTE & WIRKLOGIK (Hierher verschoben) -->
                    <div class="p-6 bg-yellow-50 rounded-lg shadow-inner border border-yellow-300">
                        <h2 class="text-2xl font-bold text-yellow-700 mb-4">2. Importierte Projekte & Wirklogik</h2>
                        <p class="text-sm text-gray-600 mb-4">
                            Projekte werden aus der Excel-Datei geladen. Tragen Sie hier die jährlichen Effekte für jedes Projekt ein.
                            Die Gesamt-P&L aggregiert die Summe aller Projekteffekte.
                        </p>
                        
                        <!-- Container für die dynamisch generierten Projekt-Input-Matrizen -->
                        <div id="projectEffectsContainer" class="space-y-6">
                            <p class="text-gray-500">Bitte laden Sie eine Excel-Projektliste, um die Eingabefelder zu sehen.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Importiere Firebase Module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, browserSessionPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query, doc, getDoc, setDoc, setLogLevel, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globale Variablen
        let db;
        let auth;
        let userId = 'N/A';
        let isAuthReady = false;
        
        // GETRENNTE KOLLEKTIONEN
        const LOGISTICS_SCENARIOS_COLLECTION = 'scenarios'; // Für E-Com Controller Tool (LESEN)
        const BUSINESS_CASES_COLLECTION = 'business_cases'; // Für dieses Tool (LESEN/SCHREIBEN)

        let loadedScenarioData = null; 
        let importedProjects = []; 
        let projectInputValues = {}; // NEU: Speichert Projekt-Input-Anpassungen
        const PLANNING_HORIZON = 5; // T+1 bis T+5 (REDUZIERT)

        // Hilfsfunktionen zur Formatierung
        const formatter = new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const percentFormatter = new Intl.NumberFormat('de-DE', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 });
        const numberFormatter = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        // =================================================================
        // HILFSFUNKTIONEN
        // =================================================================
        
        /**
         * Hilfsfunktion für den fehlerfreien Zugriff auf Input-Werte.
         */
        const getInputValue = (id) => {
            const element = document.getElementById(id);
            return parseFloat(element?.value) || 0;
        };

        /**
         * NEU: Tab-Wechsel-Logik
         */
        function showTab(tabName) {
            document.getElementById('pane-pnl').classList.toggle('hidden', tabName !== 'pnl');
            document.getElementById('pane-projects').classList.toggle('hidden', tabName === 'pnl');
            
            document.getElementById('tab-pnl').classList.toggle('active', tabName === 'pnl');
            document.getElementById('tab-pnl').classList.toggle('inactive', tabName !== 'pnl');
            
            document.getElementById('tab-projects').classList.toggle('active', tabName === 'projects');
            document.getElementById('tab-projects').classList.toggle('inactive', tabName !== 'projects');
        }
        
        // =================================================================
        // FIREBASE INITIALISIERUNG & AUTH
        // =================================================================
        async function initFirebase() {
            try {
                // 🛑 IHRE GÜLTIGE FIREBASE KONFIGURATION 🛑
                const firebaseConfig = {
                    apiKey: "AIzaSyDGzrNBazLFhxTI-O-xkdSUU-c4EIWHGF0",
                    authDomain: "business-case-kalkulator.firebaseapp.com",
                    projectId: "business-case-kalkulator",
                    storageBucket: "business-case-kalkulator.firebasestorage.app",
                    messagingSenderId: "439851647109",
                    appId: "1:439851647109:web:50faf47e5970ada8b4a9ec"
                };

                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                document.getElementById('authStatus').textContent = 'Authentifiziere...';

                await setPersistence(auth, browserSessionPersistence).catch(e => console.warn("Persistence konnte nicht gesetzt werden:", e));
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('currentUserId').textContent = userId.substring(0, 10) + '...';
                        document.getElementById('authStatus').textContent = 'Verbunden';
                        document.getElementById('authStatus').classList.remove('text-red-600');
                        document.getElementById('authStatus').classList.add('text-green-600');
                        
                        isAuthReady = true; 
                        loadScenariosListener(); // Starte Logistik-Laden
                        loadBusinessCasesListener(); // NEU: Starte Business Case-Laden
                        calculateCase();
                    } else {
                        document.getElementById('authStatus').textContent = 'Anmeldung fehlgeschlagen';
                        document.getElementById('authStatus').classList.add('text-red-600');
                        isAuthReady = false; 
                        calculateCase();
                    }
                });

            } catch (error) {
                console.error("Kritischer Firebase-Fehler bei Initialisierung/Auth: ", error);
                document.getElementById('authStatus').textContent = 'Fehler!';
                document.getElementById('authStatus').classList.add('text-red-600');
                document.getElementById('currentUserId').textContent = `Firebase: ${error.code || 'UNKNOWN'}`; 
                isAuthReady = false; 
                calculateCase(); 
            }
        }
        
        // =================================================================
        // P&L & KPI STRUKTUR UND DEFINITIONEN
        // =================================================================
        const PNL_STRUCTURE = [
            { id: 'pnl_1_order_value', label: 'Bestellwert (Brutto)', type: 'nominal' },
            { id: 'pnl_2_mwst', label: './. MwSt.', type: 'calculated', isCost: true, isMwst: true },
            { id: 'pnl_3_revenue_fakturiert', label: '= Umsatz fakturiert (Netto)', type: 'calculated', isBold: true },
            // NEU: Retourenquote in P&L
            { id: 'pnl_kpi_return_rate', label: 'Retourenquote (KPI %)', type: 'kpi' }, 
            { id: 'pnl_4_other_rev', label: '+ Sonstige Erlöse', type: 'nominal' },
            { id: 'pnl_5_cogs', label: './. Wareneinsatz', type: 'calculated', isCost: true },
            { id: 'DB1', label: '= DB 1', type: 'subtotal', color: 'text-green-600' },
            { id: 'HEADER_LOG', label: 'Abzgl. Logistik & Fracht', type: 'header' },
            { id: 'pnl_6_log_cost', label: './. Logistikkosten (OPC, P&P, etc.)', type: 'calculated', isCost: true },
            { id: 'pnl_7_shipping_out', label: './. Ausgangsfracht', type: 'calculated', isCost: true },
            { id: 'pnl_8_shipping_return', label: './. Retourenfracht', type: 'calculated', isCost: true },
            { id: 'DB2', label: '= DB 2', type: 'subtotal', color: 'text-green-700' },
            { id: 'HEADER_DIRECT', label: 'Abzgl. Direkte Kosten', type: 'header' },
            { id: 'pnl_9_sales_cost', label: './. Vertriebskosten', type: 'nominal', isCost: true },
            { id: 'pnl_10_personnel_direct', label: './. Personalkosten (Dir.)', type: 'nominal', isCost: true },
            { id: 'pnl_11_material_cost', label: './. Sachkosten', type: 'nominal', isCost: true },
            { id: 'pnl_12_depreciation_direct', label: './. Abschreibungen (Dir.)', type: 'nominal', isCost: true },
            { id: 'pnl_13_recharge_direct', label: './. Verrechnung (Dir.)', type: 'nominal', isCost: true },
            { id: 'DB3', label: '= DB 3', type: 'subtotal', color: 'text-green-800' },
            { id: 'HEADER_OVERHEAD', label: 'Abzgl. Gemeinkosten', type: 'header' },
            { id: 'pnl_14_marketing', label: './. Zentrale Vermarktung', type: 'nominal', isCost: true },
            { id: 'pnl_15_personnel_overhead', label: './. Personalkosten (Overhead)', type: 'nominal', isCost: true },
            { id: 'pnl_16_depreciation_overhead', label: './. Abschreibungen (Overhead)', type: 'nominal', isCost: true },
            { id: 'pnl_17_recharge_overhead', label: './. Verrechnung (Overhead)', type: 'nominal', isCost: true },
            { id: 'pnl_18_production', label: './. Produktion', type: 'nominal', isCost: true },
            { id: 'pnl_19_it_admin', label: './. IT/Admin', type: 'nominal', isCost: true },
            { id: 'RESULT', label: '= Gesamtergebnis (EBIT)', type: 'final', color: 'text-purple-700' }
        ];

        const KPI_STRUCTURE = [
            { id: 'orderValueBrutto', label: 'Bestellwert Brutto (€)' },
            { id: 'avgVKBrutto', label: 'Durchschnitts-VK Brutto (€)' },
            { id: 'itemsPerOrder', label: 'Artikel / Bestellung (IPO)' },
            { id: 'ordersVolume', label: 'Zahl der Bestellungen (Anzahl)' },
            { id: 'returnRate', label: 'Retourenquote (%)' },
            { id: 'marketingKUR', label: 'Marketing-KUR (%)' },
            { id: 'personnelRate', label: 'Personalkostenquote (%)' },
            { id: 'wareneinsatzRate', label: 'Wareneinsatzquote (%)' }
        ];

        const KPI_INPUT_EFFECTS = [
            { id: 'orderValueBoost', label: 'Bestellwert-Boost (c.p. %)', valueT1: 0.0 }, // Standard 0, wird pro Projekt gesetzt
            { id: 'returnRateReduction', label: 'Retourenquote Senkung (p.p.)', valueT1: 0.0 }, // p.p. = Prozentpunkte
            { id: 'avgVKBoost', label: 'Durchschnitts-VK Boost (c.p. %)', valueT1: 0.0 },
            { id: 'ipoBoost', label: 'Artikel/Bestellung Boost (c.p. %)', valueT1: 0.0 },
            { id: 'freightCostReduction', label: 'Frachtkosten-Senkung (Nominal %)', valueT1: 0.0 },
            { id: 'personnelCostReduction', label: 'Personal-Kosten-Senkung (%)', valueT1: 0.0 },
            { id: 'marketingCostReduction', label: 'Marketingkosten-Senkung (%)', valueT1: 0.0 },
            { id: 'rechargeCostReduction', label: 'Verrechnungskosten-Senkung (%)', valueT1: 0.0 }
        ];

        // =================================================================
        // LOGISTIK BERECHNUNG (Controller Logik)
        // =================================================================
        function calculateDetailedLogistics(grossRevenueNet, logCosts, returnRate) {
            const returnFactor = 1 - (returnRate / 100);
            
            // Logistik-Basis-KPIs
            const netASP = (logCosts.avgVKBrutto || 0) / (1 + (logCosts.vatRate || 0) / 100);
            const ipo = logCosts.ipo || 1; 
            const ipr = logCosts.ipr || 1;

            // Berechnung der Netto verkauften Artikel (aus Umsatz fakturiert)
            const grossItemsSoldNet = grossRevenueNet / (netASP > 0 ? netASP : 1);
            
            // Berechnung der Brutto bestellten Artikel (die Logik leitet Brutto aus Netto ab)
            const orderedItemsGross_corrected = returnFactor > 0 ? grossItemsSoldNet / returnFactor : 0; 

            // Abgeleitete Metriken
            const ordersVolume = orderedItemsGross_corrected / ipo;
            const returnItems = orderedItemsGross_corrected - grossItemsSoldNet;
            const returnShipments = returnItems / ipr; 

            // 1. Logistikkosten (P&L 6)
            const totalOrderProcessingCost = ordersVolume * (logCosts.orderProcessingCostPerOrder || 0);
            const totalPickPackCost = orderedItemsGross_corrected * (logCosts.pickPackCostPerItem || 0);
            const totalGoodsReceiptCost = orderedItemsGross_corrected * (logCosts.goodsReceiptCostPerItem || 0);
            const totalReturnProcessingCost = returnItems * (logCosts.returnProcessingCostPerItem || 0);
            const totalStorageCost = orderedItemsGross_corrected * (logCosts.storageCostPerItemPerMonth || 0) * (logCosts.avgStorageDurationMonths || 0);

            const Logistikkosten = 
                totalOrderProcessingCost + 
                totalPickPackCost + 
                totalGoodsReceiptCost +
                totalReturnProcessingCost +
                totalStorageCost;
            
            // 2. Ausgangsfracht (P&L 7)
            const Ausgangsfracht = ordersVolume * (logCosts.shippingCostOut || 0);

            // 3. Retourenfracht (P&L 8)
            const Retourenfracht = returnShipments * (logCosts.shippingCostReturnShipment || 0);

            return { Logistikkosten, Ausgangsfracht, Retourenfracht, ordersVolume, orderedItemsGross_corrected, returnItems };
        }

        // =================================================================
        // P&L BERECHNUNGSKERN
        // =================================================================
        function calculateSinglePnl(inputs, logCosts, currentKPIs) {
            const PNL = {};
            
            // 1. INPUTS & VARS
            const vatRate = inputs.pnl_kpi_vat_rate;
            const vatFactor = 1 + vatRate / 100;
            
            // Aus aktuellen KPIs (können durch Projekte verändert sein)
            const returnRate = currentKPIs.returnRate;
            const cogsRate = currentKPIs.wareneinsatzRate;
            
            // 2. TOPLINE & DB1
            PNL.pnl_1_order_value = currentKPIs.orderValueBrutto; // Bestellwert Brutto
            
            const netOrderValue = PNL.pnl_1_order_value / vatFactor; // Bestellwert Netto
            
            PNL.pnl_2_mwst = PNL.pnl_1_order_value - netOrderValue; // MwSt.
            PNL.pnl_3_revenue_fakturiert = netOrderValue * (1 - returnRate / 100); // Umsatz fakturiert (Netto)
            
            // NEU: Setze die KPI in der PNL
            PNL.pnl_kpi_return_rate = returnRate;

            PNL.pnl_4_other_rev = inputs.pnl_4_other_rev; // Sonstige Erlöse (Nominaler Input)
            
            PNL.pnl_5_cogs = PNL.pnl_3_revenue_fakturiert * (cogsRate / 100); // Wareneinsatz
            
            const GrossMargin = PNL.pnl_3_revenue_fakturiert + PNL.pnl_4_other_rev;
            PNL.DB1 = GrossMargin - PNL.pnl_5_cogs;

            // 3. LOGISTIK & DB2
            const LogisticsResult = calculateDetailedLogistics(PNL.pnl_3_revenue_fakturiert, logCosts, returnRate);
            
            // Frachtkosten-Senkung anwenden (Direkter nominaler Effekt auf die Frachtkosten)
            const freightReductionFactor = 1 - (currentKPIs.freightCostReduction / 100);

            PNL.pnl_6_log_cost = LogisticsResult.Logistikkosten; // Logistikkosten (P&P, OPC etc.)
            PNL.pnl_7_shipping_out = LogisticsResult.Ausgangsfracht * freightReductionFactor; // Ausgangsfracht (reduziert)
            PNL.pnl_8_shipping_return = LogisticsResult.Retourenfracht * freightReductionFactor; // Retourenfracht (reduziert)
            
            const TotalLogistics = PNL.pnl_6_log_cost + PNL.pnl_7_shipping_out + PNL.pnl_8_shipping_return;
            PNL.DB2 = PNL.DB1 - TotalLogistics;
            
            // 4. DIREKTE KOSTEN & DB3 (Pers. Dir. reduziert)
            const personnelDirectReductionFactor = 1 - (currentKPIs.personnelCostReduction / 100);
            const rechargeDirectReductionFactor = 1 - (currentKPIs.rechargeCostReduction / 100);

            PNL.pnl_9_sales_cost = inputs.pnl_9_sales_cost;
            PNL.pnl_10_personnel_direct = inputs.pnl_10_personnel_direct * personnelDirectReductionFactor; 
            PNL.pnl_11_material_cost = inputs.pnl_11_material_cost; 
            PNL.pnl_12_depreciation_direct = inputs.pnl_12_depreciation_direct; 
            PNL.pnl_13_recharge_direct = inputs.pnl_13_recharge_direct * rechargeDirectReductionFactor; 
            
            const TotalDirectCost = PNL.pnl_9_sales_cost + PNL.pnl_10_personnel_direct + PNL.pnl_11_material_cost + PNL.pnl_12_depreciation_direct + PNL.pnl_13_recharge_direct;
            PNL.DB3 = PNL.DB2 - TotalDirectCost;
            
            // 5. GEMEINKOSTEN & ERGEBNIS (Marketing, Pers. Over., Verrechnung Overhead reduziert)
            const marketingReductionFactor = 1 - (currentKPIs.marketingCostReduction / 100);

            // Annahme: Alle Personalkosten (Dir & Overhead) werden durch den gleichen Faktor reduziert
            PNL.pnl_14_marketing = inputs.pnl_14_marketing * marketingReductionFactor;
            PNL.pnl_15_personnel_overhead = inputs.pnl_15_personnel_overhead * personnelDirectReductionFactor; 
            PNL.pnl_16_depreciation_overhead = inputs.pnl_16_depreciation_overhead;
            PNL.pnl_17_recharge_overhead = inputs.pnl_17_recharge_overhead * rechargeDirectReductionFactor; 
            PNL.pnl_18_production = inputs.pnl_18_production;
            PNL.pnl_19_it_admin = inputs.pnl_19_it_admin;

            const TotalOverhead = PNL.pnl_14_marketing + PNL.pnl_15_personnel_overhead + PNL.pnl_16_depreciation_overhead + PNL.pnl_17_recharge_overhead + PNL.pnl_18_production + PNL.pnl_19_it_admin;
            PNL.RESULT = PNL.DB3 - TotalOverhead;

            return { PNL, LogisticsResult };
        }

        // =================================================================
        // AGGREGATION DER PROJEKT-EFFEKTE (NEU)
        // =================================================================
        function aggregateProjectEffects() {
            // Initialisiert ein leeres Objekt für die Summe der Effekte
            const aggregatedEffects = {};
            KPI_INPUT_EFFECTS.forEach(effect => {
                aggregatedEffects[effect.id] = {};
                for (let t = 1; t <= PLANNING_HORIZON; t++) {
                    aggregatedEffects[effect.id][t] = 0; // Starte jedes Jahr bei 0
                }
            });

            // Iteriere über alle importierten Projekte
            for (let i = 0; i < importedProjects.length; i++) {
                // Iteriere über alle möglichen Effekt-Typen (Bestellwert, Retoure, etc.)
                KPI_INPUT_EFFECTS.forEach(effect => {
                    // Iteriere über alle 5 Planungsjahre
                    for (let t = 1; t <= PLANNING_HORIZON; t++) {
                        // Lese den Wert aus dem spezifischen Input-Feld des Projekts
                        const inputId = `project_${i}_${effect.id}_T${t}`;
                        // NEU: Verwende den globalen Speicher 'projectInputValues'
                        const projectEffectValue = projectInputValues[inputId] || 0;
                        
                        // Addiere den Effekt des Projekts zur Gesamtsumme dieses Jahres
                        aggregatedEffects[effect.id][t] += projectEffectValue;
                    }
                });
            }
            return aggregatedEffects;
        }


        // =================================================================
        // GESAMTBERECHNUNG (5 JAHRE)
        // =================================================================
        function calculateCase() {
            
            // --- 1. P&L INPUTS T=0 (Basis) ---
            const inputsT0 = {
                pnl_1_order_value: getInputValue('pnl_1_order_value'),
                pnl_kpi_vat_rate: getInputValue('pnl_kpi_vat_rate'),
                pnl_kpi_return_rate: getInputValue('pnl_kpi_return_rate'),
                pnl_kpi_avg_vk: 65, // Basis VK Brutto (wird von Logik benötigt)
                pnl_kpi_ipo: 1.2, // Basis IPO (wird von Logik benötigt)
                pnl_4_other_rev: getInputValue('pnl_4_other_rev'),
                pnl_kpi_cogs_rate: getInputValue('pnl_kpi_cogs_rate'),
                
                // Aggregierte Kosten (für die Demo aufgesplittet)
                pnl_9_sales_cost: getInputValue('pnl_9_sales_cost') * 0.4, 
                pnl_10_personnel_direct: getInputValue('pnl_9_sales_cost') * 0.3,
                pnl_11_material_cost: getInputValue('pnl_9_sales_cost') * 0.1, 
                pnl_12_depreciation_direct: getInputValue('pnl_9_sales_cost') * 0.1, 
                pnl_13_recharge_direct: getInputValue('pnl_9_sales_cost') * 0.1, 

                pnl_14_marketing: getInputValue('pnl_14_marketing') * 0.4, 
                pnl_15_personnel_overhead: getInputValue('pnl_14_marketing') * 0.3, 
                pnl_16_depreciation_overhead: getInputValue('pnl_14_marketing') * 0.1, 
                pnl_17_recharge_overhead: getInputValue('pnl_14_marketing') * 0.1, 
                pnl_18_production: getInputValue('pnl_14_marketing') * 0.05, 
                pnl_19_it_admin: getInputValue('pnl_14_marketing') * 0.05,
            };
            
            // --- 2. BASIS LOGISTIK KOSTEN (als Fallback) ---
            const baseLogisticsCosts = {
                vatRate: inputsT0.pnl_kpi_vat_rate, 
                avgVKBrutto: inputsT0.pnl_kpi_avg_vk, ipo: inputsT0.pnl_kpi_ipo, ipr: 1.2, 
                shippingCostOut: 4.99, shippingCostReturnShipment: 5.99,
                orderProcessingCostPerOrder: 1.50, pickPackCostPerItem: 1.10, goodsReceiptCostPerItem: 0.50,
                returnProcessingCostPerItem: 2.50, storageCostPerItemPerMonth: 0.10, avgStorageDurationMonths: 3.0,
            };
            
            // --- 3. AGGREGIERTE PROJEKT-EFFEKTE (NEU) ---
            const aggregatedEffects = aggregateProjectEffects();

            // --- 4. AKTUELLE KPI-WERTE (Basis für T=0) ---
            let CURRENT_KPI_BASE = {
                orderValueBrutto: inputsT0.pnl_1_order_value,
                avgVKBrutto: inputsT0.pnl_kpi_avg_vk,
                itemsPerOrder: inputsT0.pnl_kpi_ipo,
                returnRate: inputsT0.pnl_kpi_return_rate,
                wareneinsatzRate: inputsT0.pnl_kpi_cogs_rate,
                freightCostReduction: 0, 
                personnelCostReduction: 0,
                marketingCostReduction: 0,
                rechargeCostReduction: 0,
            };
            
            // --- 5. 5-JAHRES BERECHNUNG ---
            const PNL_YEARS = {}; // Speichert PNL für jedes Jahr (T0, T1, ..., T5)
            const KPI_YEARS = {}; // Speichert KPIs für jedes Jahr

            // T=0 ist die Basis
            const T0_Result = calculateSinglePnl(inputsT0, baseLogisticsCosts, CURRENT_KPI_BASE);
            PNL_YEARS[0] = T0_Result.PNL;
            KPI_YEARS[0] = { 
                ...CURRENT_KPI_BASE,
                ordersVolume: T0_Result.LogisticsResult.ordersVolume,
                returnRate: inputsT0.pnl_kpi_return_rate,
                marketingKUR: (inputsT0.pnl_14_marketing) / (PNL_YEARS[0].pnl_3_revenue_fakturiert || 1) * 100, 
                personnelRate: (inputsT0.pnl_10_personnel_direct + inputsT0.pnl_15_personnel_overhead) / (PNL_YEARS[0].pnl_3_revenue_fakturiert || 1) * 100
            };
            
            // T=1 bis T=5
            let currentKPIs = { ...CURRENT_KPI_BASE };
            let logisticsCostsT = { ...baseLogisticsCosts };

            for (let t = 1; t <= PLANNING_HORIZON; t++) {
                
                // 5.1. AKKUMULATION DER KPI-EFFEKTE (Jährlicher Boost/Reduktion auf Basis des Vorjahres)
                
                // **Wirkung 1: Bestellwert-Boost**
                const orderValueBoostPct = aggregatedEffects.orderValueBoost[t] / 100;
                currentKPIs.orderValueBrutto = currentKPIs.orderValueBrutto * (1 + orderValueBoostPct);

                // **Wirkung 5 & 6: Durchschnitts-VK / IPO Boost** (Verändern die Logistik-Basis)
                const avgVKBoostPct = aggregatedEffects.avgVKBoost[t] / 100;
                const ipoBoostPct = aggregatedEffects.ipoBoost[t] / 100;

                currentKPIs.avgVKBrutto = currentKPIs.avgVKBrutto * (1 + avgVKBoostPct);
                currentKPIs.itemsPerOrder = currentKPIs.itemsPerOrder * (1 + ipoBoostPct);
                
                // **Wirkung 2: Retourenquote Senkung** (Wird von p.p. [Prozentpunkte] abgezogen)
                const returnRateReductionPP = aggregatedEffects.returnRateReduction[t];
                currentKPIs.returnRate = Math.max(0, currentKPIs.returnRate - returnRateReductionPP); // Kann nicht negativ sein

                // **Wirkung 3, 4, 7, 8: Kosten-Reduktion** (Wird als prozentualer Reduktionsfaktor gespeichert)
                currentKPIs.freightCostReduction = currentKPIs.freightCostReduction + aggregatedEffects.freightCostReduction[t];
                currentKPIs.personnelCostReduction = currentKPIs.personnelCostReduction + aggregatedEffects.personnelCostReduction[t];
                currentKPIs.marketingCostReduction = currentKPIs.marketingCostReduction + aggregatedEffects.marketingCostReduction[t];
                currentKPIs.rechargeCostReduction = currentKPIs.rechargeCostReduction + aggregatedEffects.rechargeCostReduction[t];

                // 5.2. Logistik-Szenario anwenden (falls geladen) - überschreibt nur die Logistik-Konditionen
                if (loadedScenarioData) {
                    logisticsCostsT.shippingCostOut = parseFloat(loadedScenarioData.shippingCostOut) || logisticsCostsT.shippingCostOut;
                    logisticsCostsT.shippingCostReturnShipment = parseFloat(loadedScenarioData.shippingCostReturnShipment) || logisticsCostsT.shippingCostReturnShipment;
                    logisticsCostsT.orderProcessingCostPerOrder = parseFloat(loadedScenarioData.orderProcessingCostPerOrder) || logisticsCostsT.orderProcessingCostPerOrder;
                    logisticsCostsT.pickPackCostPerItem = parseFloat(loadedScenarioData.pickPackCostPerItem) || logisticsCostsT.pickPackCostPerItem;
                    logisticsCostsT.goodsReceiptCostPerItem = parseFloat(loadedScenarioData.goodsReceiptCostPerItem) || logisticsCostsT.goodsReceiptCostPerItem;
                    logisticsCostsT.returnProcessingCostPerItem = parseFloat(loadedScenarioData.returnProcessingCostPerItem) || logisticsCostsT.returnProcessingCostPerItem;
                    logisticsCostsT.storageCostPerItemPerMonth = parseFloat(loadedScenarioData.storageCostPerItemPerMonth) || logisticsCostsT.storageCostPerItemPerMonth;
                    logisticsCostsT.avgStorageDurationMonths = parseFloat(loadedScenarioData.avgStorageDurationMonths) || logisticsCostsT.avgStorageDurationMonths;
                    
                    // Überschreibe auch die Basis-KPIs aus dem Szenario (falls vorhanden)
                    currentKPIs.avgVKBrutto = parseFloat(loadedScenarioData.avgVKBrutto) || currentKPIs.avgVKBrutto;
                    currentKPIs.itemsPerOrder = parseFloat(loadedScenarioData.ipo) || currentKPIs.itemsPerOrder;
                    currentKPIs.returnRate = parseFloat(loadedScenarioData.returnRate) || currentKPIs.returnRate;
                }
                
                // Die aktuellen KPIs werden in die Logistikkosten-Struktur für die Berechnung übernommen
                logisticsCostsT.avgVKBrutto = currentKPIs.avgVKBrutto;
                logisticsCostsT.ipo = currentKPIs.itemsPerOrder;
                logisticsCostsT.vatRate = inputsT0.pnl_kpi_vat_rate; // MwSt. bleibt gleich

                // 5.3. Endgültige PNL für das Jahr berechnen
                const Year_T_Result = calculateSinglePnl(inputsT0, logisticsCostsT, currentKPIs);
                PNL_YEARS[t] = Year_T_Result.PNL;
                
                // 5.4. KPI-Werte speichern
                KPI_YEARS[t] = {
                    ...currentKPIs,
                    ordersVolume: Year_T_Result.LogisticsResult.ordersVolume,
                    marketingKUR: (PNL_YEARS[t].pnl_14_marketing || 0) / (PNL_YEARS[t].pnl_3_revenue_fakturiert || 1) * 100, 
                    personnelRate: ( (PNL_YEARS[t].pnl_10_personnel_direct || 0) + (PNL_YEARS[t].pnl_15_personnel_overhead || 0) ) / (PNL_YEARS[t].pnl_3_revenue_fakturiert || 1) * 100,
                    wareneinsatzRate: currentKPIs.wareneinsatzRate, // COGS-Rate wird hier als statischer Input betrachtet
                };
            }
            
            // --- 6. DOM AKTUALISIEREN ---
            renderPnlTable(PNL_YEARS);
            renderKpiTable(KPI_YEARS);
        }

        // =================================================================
        // RENDERING DER PROJEKT-INPUT-MATRIZEN (Layout korrigiert)
        // =================================================================
        function renderProjectInputs(projects, inputValues = {}) {
            const container = document.getElementById('projectEffectsContainer');
            if (!container) return;
            
            // Erstelle ein einziges großes Grid
            let html = `<div class="table-container kpi-input-grid grid-cols-kpi-input-projects">`;

            // Header für diese Projekt-Matrix
            html += `
                <div class="grid-cell grid-header grid-sticky-col" style="left: 0px;">Projektname</div>
                <div class="grid-cell grid-header grid-sticky-col" style="left: 220px; z-index: 11;">Wirkung (KPI)</div> <!-- Zweite sticky Spalte -->
                <div class="grid-cell grid-header text-right">T+1</div>
                <div class="grid-cell grid-header text-right">T+2</div>
                <div class="grid-cell grid-header text-right">T+3</div>
                <div class="grid-cell grid-header text-right">T+4</div>
                <div class="grid-cell grid-header text-right">T+5</div>
            `;

            // Iteriere über alle Projekte UND dann über alle Effekte
            projects.forEach((project, index) => {
                const projectName = project.Projektname || `Projekt ${index + 1}`; // KORREKTUR RÜCKGÄNGIG: "Projektname"
                
                KPI_INPUT_EFFECTS.forEach((effect, effectIndex) => {
                    
                    // Erste Spalte: Projektname (nur bei der ersten Effekt-Zeile anzeigen und über alle Effekt-Zeilen spannen)
                    if (effectIndex === 0) {
                        html += `<div class="grid-cell grid-sticky-col" style="left: 0px; grid-row: span ${KPI_INPUT_EFFECTS.length}; align-self: center; background-color: #f9fafb;">${projectName}</div>`;
                    }

                    // Zweite Spalte: Effekt-Label
                    html += `<div class="grid-cell grid-sticky-col" style="left: 220px; z-index: 11; background-color: #fefce8;">${effect.label}</div>`;

                    // Jahres-Inputfelder
                    for (let t = 1; t <= PLANNING_HORIZON; t++) {
                        // Eindeutige ID pro Projekt und Effekt: project_INDEX_EFFECTID_JAHR
                        const inputId = `project_${index}_${effect.id}_T${t}`;
                        
                        // NEU: Werte aus 'inputValues' (geladen) oder Excel oder 0.0
                        let value = 0.0;
                        if (inputValues[inputId] !== undefined) {
                            value = inputValues[inputId]; // Nimm den gespeicherten Wert
                        } else {
                            const excelKey = `${effect.id}_T${t}`; // Lese den Wert aus der Excel-Datei
                            value = project[excelKey] || 0.0; 
                        }
                        
                        // Speichere den Initialwert im globalen Objekt
                        projectInputValues[inputId] = value;

                        html += `<div class="grid-cell">
                                    <input type="number" id="${inputId}" value="${value.toFixed(1)}" step="0.1" oninput="updateProjectInputValue('${inputId}', this.value)">
                                 </div>`;
                    }
                });
            });
            
            html += `</div>`; // Ende des Grids
            container.innerHTML = html; // Setze das gesamte HTML
        }

        // NEU: Funktion zum Speichern von Projekt-Input-Änderungen
        function updateProjectInputValue(inputId, value) {
            projectInputValues[inputId] = parseFloat(value) || 0;
            calculateCase(); // Berechne die P&L neu, wenn ein Projektwert geändert wird
        }
        
        // =================================================================
        // RENDERING DER P&L TABELLE (Layout korrigiert)
        // =================================================================
        function renderPnlTable(PNL_YEARS) {
            const pnlTable = document.getElementById('pnlTable');
            const startYear = getInputValue('startYear') || new Date().getFullYear();

            // 1. Header generieren
            let headerHtml = `<div class="grid-cell grid-header grid-sticky-col">P&L Position</div>`;
            for (let t = 0; t <= PLANNING_HORIZON; t++) {
                headerHtml += `<div class="grid-cell grid-header text-right">${startYear + t} (€)</div>`;
                headerHtml += `<div class="grid-cell grid-header text-right pnl-percent">${startYear + t} (%)</div>`;
            }

            // 2. Body generieren
            let bodyHtml = '';
            PNL_STRUCTURE.forEach(item => {
                if (item.type === 'header') {
                    // Span über alle Spalten (1 Label + 6 Jahre * 2 Spalten = 13)
                    bodyHtml += `<div class="grid-cell pnl-header-row" style="grid-column: 1 / span 13;">${item.label}</div>`;
                    return;
                }

                let rowClass = item.type === 'subtotal' ? 'pnl-subtotal' : item.type === 'final' ? 'pnl-final' : '';
                
                // Erste Spalte: Label
                bodyHtml += `<div class="grid-cell grid-sticky-col ${rowClass}">${item.label}</div>`;

                for (let t = 0; t <= PLANNING_HORIZON; t++) {
                    const pnlYear = PNL_YEARS[t] || {};
                    const value = pnlYear[item.id] || 0;
                    const baseRevenue = pnlYear.pnl_3_revenue_fakturiert || 1;
                    
                    let valueDisplay;
                    let percentDisplay;
                    let valueClass = '';

                    // NEUE LOGIK FÜR KPI-ZEILE
                    if (item.type === 'kpi') {
                        valueDisplay = `${value.toFixed(1)} %`;
                        percentDisplay = 'N/A';
                        valueClass = 'font-semibold bg-yellow-50';
                    } else {
                        valueDisplay = formatter.format(value);
                        
                        if (item.id === 'pnl_1_order_value' || item.id === 'pnl_2_mwst') {
                             percentDisplay = 'N/A';
                        } else if (item.id === 'pnl_3_revenue_fakturiert') {
                             percentDisplay = percentFormatter.format(1); // Umsatz ist immer 100% seiner selbst
                        } else {
                            percentDisplay = percentFormatter.format(value / baseRevenue);
                        }
                    }
                    
                    if (item.type === 'final' || item.type === 'subtotal') {
                        valueClass = 'font-bold';
                        if (t > 0 && value < (PNL_YEARS[t-1]?.[item.id] || 0)) valueClass += ' text-red-600';
                        if (t > 0 && value > (PNL_YEARS[t-1]?.[item.id] || 0)) valueClass += ' text-green-600';
                    } else if (item.isCost) {
                        if (t > 0) {
                            valueClass = value > (PNL_YEARS[t-1]?.[item.id] || 0) ? 'text-red-600' : 'text-green-600';
                        }
                    }

                    bodyHtml += `<div class="grid-cell text-right ${rowClass} ${valueClass}">${valueDisplay}</div>`;
                    bodyHtml += `<div class="grid-cell text-right pnl-percent ${rowClass}">${percentDisplay}</div>`;
                }
            });
            
            // 3. HTML injizieren
            pnlTable.innerHTML = headerHtml + bodyHtml;
        }

        // =================================================================
        // RENDERING DER KPI TABELLE (Layout korrigiert)
        // =================================================================
        function renderKpiTable(KPI_YEARS) {
            const kpiTable = document.getElementById('kpiTable');
            const startYear = getInputValue('startYear') || new Date().getFullYear();

            // 1. Header generieren
            let headerHtml = `<div class="grid-cell grid-header grid-sticky-col">KPI</div>`;
            for (let t = 0; t <= PLANNING_HORIZON; t++) {
                headerHtml += `<div class="grid-cell grid-header text-right">${startYear + t}</div>`;
            }

            // 2. Body generieren
            let bodyHtml = '';
            KPI_STRUCTURE.forEach(item => {
                // Erste Spalte: Label
                bodyHtml += `<div class="grid-cell grid-sticky-col kpi-row">${item.label}</div>`;

                for (let t = 0; t <= PLANNING_HORIZON; t++) {
                    const kpiYear = KPI_YEARS[t] || {};
                    const value = kpiYear[item.id] || 0;
                    
                    let valueDisplay;
                    let valueClass = '';

                    if (item.id === 'returnRate' || item.id === 'marketingKUR' || item.id === 'personnelRate' || item.id === 'wareneinsatzRate') {
                        valueDisplay = `${value.toFixed(1)} %`;
                    } else if (item.id === 'ordersVolume') {
                        valueDisplay = numberFormatter.format(value);
                    } else if (item.id === 'itemsPerOrder') {
                         valueDisplay = value.toFixed(2);
                    } else {
                        valueDisplay = formatter.format(value);
                    }
                    
                    if (t > 0) {
                         const t0Value = KPI_YEARS[0]?.[item.id] || 0;
                         if (item.id === 'returnRate' || item.id === 'marketingKUR' || item.id === 'personnelRate' || item.id === 'wareneinsatzRate') {
                            valueClass = value < t0Value ? 'text-green-600 font-semibold' : value > t0Value ? 'text-red-600 font-semibold' : '';
                         } else {
                            valueClass = value > t0Value ? 'text-green-600 font-semibold' : value < t0Value ? 'text-red-600 font-semibold' : '';
                         }
                    }

                    bodyHtml += `<div class="grid-cell text-right kpi-row ${valueClass}">${valueDisplay}</div>`;
                }
            });
            
            // 3. HTML injizieren
            kpiTable.innerHTML = headerHtml + bodyHtml;
        }

        // =================================================================
        // DATEI-UPLOAD LOGIK
        // =================================================================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    importedProjects = json;
                    
                    document.getElementById('projectImportStatus').innerHTML = `<span class="text-green-600">Erfolgreich geladen: ${importedProjects.length} Projekte.</span>`;
                    
                    // NEU: Projekteingabefelder rendern (leert projectInputValues)
                    projectInputValues = {}; // Setze Anpassungen zurück
                    renderProjectInputs(importedProjects, projectInputValues);
                    
                    calculateCase(); // Neuberechnung mit Projekt-Daten
                } catch (error) {
                    console.error("Fehler beim Lesen der Excel-Datei:", error);
                     document.getElementById('projectImportStatus').innerHTML = '<span class="text-red-600">Fehler: Datei konnte nicht gelesen werden.</span>';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // =================================================================
        // SZENARIO SPEICHERN & LADEN
        // =================================================================
        
        // Speichern-Button Event Listener
        document.getElementById('saveScenarioBtn')?.addEventListener('click', async () => {
            if (!isAuthReady || !db) {
                alert('Firebase ist nicht verbunden. Speichern nicht möglich.');
                return;
            }
            const scenarioName = document.getElementById('scenarioNameInput')?.value;
            if (!scenarioName) {
                alert('Bitte geben Sie einen Szenario-Namen ein.');
                return;
            }

            // KORREKTUR: Speichert ALLE relevanten Daten
            const scenarioData = {
                scenarioName: scenarioName,
                createdAt: new Date().toISOString(),
                userId: userId,
                // T=0 Basis-Inputs
                baseInputs: {
                    pnl_1_order_value: getInputValue('pnl_1_order_value'),
                    pnl_kpi_return_rate: getInputValue('pnl_kpi_return_rate'),
                    pnl_kpi_cogs_rate: getInputValue('pnl_kpi_cogs_rate'),
                    pnl_4_other_rev: getInputValue('pnl_4_other_rev'),
                    pnl_9_sales_cost: getInputValue('pnl_9_sales_cost'),
                    pnl_14_marketing: getInputValue('pnl_14_marketing'),
                    pnl_kpi_vat_rate: getInputValue('pnl_kpi_vat_rate'),
                },
                // Die Rohdaten der Excel-Datei
                importedProjects: importedProjects,
                // Alle Anpassungen, die in den Projekt-Matrizen vorgenommen wurden
                projectInputValues: projectInputValues 
            };

            try {
                // KORREKTUR: Speichert in 'business_cases' Kollektion
                const docRef = await addDoc(collection(db, BUSINESS_CASES_COLLECTION), scenarioData);
                document.getElementById('scenarioStatus').textContent = `Business Case "${scenarioName}" gespeichert.`;
                alert(`Business Case "${scenarioName}" erfolgreich gespeichert!`);
            } catch (error) {
                console.error("Fehler beim Speichern des Szenarios: ", error);
                let errorMsg = 'Fehler beim Speichern!';
                if (error.code === 'permission-denied') {
                    errorMsg = 'Fehler: Zugriff verweigert. Bitte Firestore-Regeln für "business_cases" (Schreibzugriff) prüfen!';
                }
                document.getElementById('scenarioStatus').textContent = errorMsg;
                alert(errorMsg);
            }
        });

        // Szenario-Liste laden (Logistik-Szenarien)
        function loadScenariosListener() {
            if (!db) return;
            // KORREKTUR: Liest aus 'scenarios' (dem E-Com Controller Tool)
            const scenariosQuery = query(collection(db, LOGISTICS_SCENARIOS_COLLECTION));
            
            onSnapshot(scenariosQuery, (snapshot) => {
                const selector = document.getElementById('scenarioSelector');
                const selectedValue = selector.value;
                
                selector.innerHTML = '<option value="">--- Logistik-Szenario laden ---</option>';

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.scenarioName || `Szenario ${doc.id.substring(0,5)}`;
                    if (doc.id === selectedValue) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
                
            }, (error) => {
                console.error("Fehler beim Laden der Szenarien-Liste: ", error);
                document.getElementById('scenarioStatus').textContent = 'Fehler: Szenarien konnten nicht geladen werden.';
                if (error.code === 'permission-denied') {
                     document.getElementById('scenarioStatus').innerHTML = '<span class="text-red-600">Fehler: Zugriff verweigert. Bitte Firestore-Regeln für "scenarios" prüfen!</span>';
                }
            });
        }

        // NEU: Business Case-Liste laden
        function loadBusinessCasesListener() {
            if (!db) return;
            const casesQuery = query(collection(db, BUSINESS_CASES_COLLECTION));
            
            onSnapshot(casesQuery, (snapshot) => {
                const selector = document.getElementById('caseSelector');
                const selectedValue = selector.value;
                
                selector.innerHTML = '<option value="">--- Business Case laden ---</option>';

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.scenarioName || `Case ${doc.id.substring(0,5)}`;
                    if (doc.id === selectedValue) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
                
            }, (error) => {
                console.error("Fehler beim Laden der Business Case-Liste: ", error);
                if (error.code === 'permission-denied') {
                     alert('Fehler: Zugriff verweigert. Bitte Firestore-Regeln für "business_cases" (Lesezugriff) prüfen!');
                }
            });
        }

        // Ein spezifisches Logistik-Szenario laden
        async function loadScenarioData(docId) {
            if (!db || !docId) {
                loadedScenarioData = null;
                document.getElementById('scenarioStatus').textContent = 'Kein Logistik-Szenario geladen.';
                calculateCase();
                return;
            }
            
            document.getElementById('scenarioSpinner').classList.remove('hidden');

            try {
                const docRef = doc(db, LOGISTICS_SCENARIOS_COLLECTION, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    loadedScenarioData = docSnap.data();
                    document.getElementById('scenarioStatus').textContent = `Logistik-Szenario "${loadedScenarioData.scenarioName}" geladen.`;
                    calculateCase(); // Neuberechnung mit den Daten des Szenarios
                } else {
                    document.getElementById('scenarioStatus').textContent = 'Fehler: Szenario nicht gefunden.';
                    loadedScenarioData = null;
                }
            } catch (error) {
                 console.error("Fehler beim Laden des Logistik-Szenarios: ", error);
                 document.getElementById('scenarioStatus').textContent = 'Fehler beim Laden.';
                 loadedScenarioData = null;
            } finally {
                document.getElementById('scenarioSpinner').classList.add('hidden');
            }
        }

        // NEU: Einen spezifischen Business Case laden
        async function loadBusinessCase(docId) {
            const caseSpinner = document.getElementById('caseSpinner');
            if (!db || !docId) {
                return;
            }
            
            caseSpinner.classList.remove('hidden');

            try {
                const docRef = doc(db, BUSINESS_CASES_COLLECTION, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Lade T=0 Basis-Inputs
                    const inputs = data.baseInputs || {};
                    Object.keys(inputs).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = inputs[key];
                    });
                    
                    // 2. Lade Projekt-Daten
                    importedProjects = data.importedProjects || [];
                    projectInputValues = data.projectInputValues || {};
                    
                    // 3. Rendere die Projekt-Inputs mit den geladenen Werten
                    renderProjectInputs(importedProjects, projectInputValues);
                    
                    // 4. Setze den Namen
                    document.getElementById('scenarioNameInput').value = data.scenarioName || '';
                    document.getElementById('scenarioStatus').textContent = `Business Case "${data.scenarioName}" geladen.`;
                    
                    calculateCase(); // Neuberechnung mit den geladenen Daten
                } else {
                    document.getElementById('scenarioStatus').textContent = 'Fehler: Business Case nicht gefunden.';
                }
            } catch (error) {
                 console.error("Fehler beim Laden des Business Case: ", error);
                 document.getElementById('scenarioStatus').textContent = 'Fehler beim Laden des Case.';
            } finally {
                caseSpinner.classList.add('hidden');
            }
        }

        // =================================================================
        // STARTPUNKT
        // =================================================================
        window.onload = function() {
            // Globale Funktionen verfügbar machen
            window.calculateCase = calculateCase;
            window.handleFileUpload = (event) => handleFileUpload(event);
            window.loadScenarioData = loadScenarioData;
            window.loadBusinessCase = loadBusinessCase; // NEU
            window.showTab = showTab;
            window.updateProjectInputValue = updateProjectInputValue; // NEU

            // Event Listener für Excel-Upload manuell binden
            const excelFileInput = document.getElementById('excelFile');
            if (excelFileInput) {
                excelFileInput.addEventListener('change', handleFileUpload);
            }

            // NEU: Event Listener für Business Case Lade-Dropdown
            const caseSelector = document.getElementById('caseSelector');
            if (caseSelector) {
                caseSelector.addEventListener('change', (e) => loadBusinessCase(e.target.value));
            }

            initFirebase(); // Startet Firebase UND ruft calculateCase() auf
        }
    </script>
</body>
</html>

